<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¸ë¦¼ì—ì„œ ì˜ëª»ëœ ê²ƒì€? - AI ë¶„ì„ í†µí•©í˜•</title>

    <script type="module">
        import { FIREBASE_CONFIG, GEMINI_API_KEY, ADMIN_PASSWORD } from "./secrets.js";

        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, setDoc, query, orderBy, getDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. Firebase ì„¤ì • (ë³¸ì¸ì˜ í”„ë¡œì íŠ¸ í‚¤ë¡œ êµì²´ í•„ìš”) ---
        // Firebase ì½˜ì†” -> í”„ë¡œì íŠ¸ ì„¤ì • -> ë‚´ ì•± -> SDK ì„¤ì • ë° êµ¬ì„± ì—ì„œ ë³µì‚¬
        const app = initializeApp(FIREBASE_CONFIG);
        const db = getFirestore(app);

        // [ì¤‘ìš”] ì¼ë°˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì“°ê¸° ìœ„í•´ window ê°ì²´ì— ë“±ë¡
        window.fs = { db, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, setDoc, query, orderBy, getDoc, where };

        // --- 2. Google AI ì„¤ì • (ê¸°ì¡´ ìœ ì§€) ---
        const API_KEY = GEMINI_API_KEY;

        // --- 3. ì¸ì¦ ë° ê¸°ë³¸ í•¨ìˆ˜ë“¤ ---
        const auth = getAuth();

        signInAnonymously(auth)
            .then(() => {
                console.log("ë¹„íšŒì› ë¡œê·¸ì¸ ì„±ê³µ");
            })
            .catch((error) => {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
            });

        window.getEmbeddingsFromGoogle = async function (textArray) {
            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "models/text-embedding-004" });
                const promises = textArray.map(async (text) => {
                    const result = await model.embedContent(text);
                    return result.embedding.values;
                });
                return await Promise.all(promises);
            } catch (error) {
                console.error("AI ì—°ê²° ì—ëŸ¬:", error);
                throw error;
            }
        };
    </script>

    <style>
        /* --- [Post_ì´ˆì•ˆ_AI3 ìŠ¤íƒ€ì¼ 100% ë³µêµ¬] --- */
        :root {
            --primary: #2563eb;
            --admin-color: #7c3aed;
            --bg: #f8fafc;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            margin: 0;
            background: var(--bg);
            color: #333;
        }

        .mode-selector {
            background: #1e293b;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .mode-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
            opacity: 0.6;
        }

        .mode-btn.active {
            opacity: 1;
            transform: scale(1.05);
            border: 2px solid white;
        }

        .btn-admin-nav {
            background: var(--admin-color);
        }

        .btn-user-nav {
            background: var(--primary);
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .photo-display {
            width: 100%;
            min-height: 200px;
            background: #e2e8f0;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px dashed #cbd5e1;
            position: relative;
        }

        .photo-display img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
        }

        video {
            width: 100%;
            height: auto;
            display: none;
        }

        .card {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        input[type="text"],
        input[type="date"] {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        .btn-p {
            background: var(--primary);
        }

        .btn-a {
            background: var(--admin-color);
        }

        .btn-d {
            background: #ef4444;
        }

        #printLayer {
            display: none;
        }

        .thumb-img {
            width: 50px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 850px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .group-box {
            border-left: 5px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            background: #f1f5f9;
        }

        .common-group {
            border-left-color: var(--primary);
        }

        .unique-group {
            border-left-color: #94a3b8;
        }

        .group-tag {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 10px;
            color: white;
        }

        .tag-common {
            background: var(--primary);
        }

        .tag-unique {
            background: #64748b;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .draggable-item {
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
            border-bottom: 1px solid #eee;
        }

        .drag-over {
            background-color: #dbeafe !important;
            border: 2px dashed var(--primary) !important;
        }

        .is-rep {
            background: rgba(255, 251, 235, 0.8) !important;
            border-left: 4px solid #10b981 !important;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 0;
            }

            html,
            body {
                width: 297mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                background: white;
                overflow: hidden;
            }

            body>* {
                display: none !important;
            }

            #printLayer {
                display: grid !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 297mm;
                height: 210mm;
                padding: 10mm 15mm;
                /* ìƒí•˜ 10mm, ì¢Œìš° 15mm */
                box-sizing: border-box;
                grid-template-columns: repeat(3, 1fr);
                grid-auto-rows: 80mm;
                gap: 5mm;
                background: white;
                z-index: 9999;
            }

            #analysisModal[style*="display: flex"] {
                display: flex !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10000;
                background: white;
            }

            #analysisModal[style*="display: flex"] .modal-content {
                box-shadow: none;
                width: 100%;
                max-width: none;
            }

            #analysisModal button {
                display: none !important;
            }

            .post-it-card {
                background-color: #fffb88 !important;
                border: 1px solid #eab308;
                padding: 10px;
                position: relative;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                height: 80mm;
                box-sizing: border-box;
                page-break-inside: avoid;
            }

            .card-header h3 {
                margin: 0;
                font-size: 15pt;
                border-bottom: 2px dashed #d97706;
                padding-bottom: 5px;
                position: relative;
                z-index: 10;
            }

            .card-body {
                flex-grow: 1;
                font-family: 'Gungsuh', serif;
                margin-top: 5px;
                line-height: 1.3;
                z-index: 10;
                word-break: break-all;
                position: relative;
            }

            .card-img-box {
                position: absolute;
                bottom: 0;
                right: 0;
                width: 55%;
                height: 55%;
                z-index: 1;
                opacity: 0.25;
                display: flex;
                align-items: flex-end;
                justify-content: flex-end;
                padding: 5px;
                pointer-events: none;
            }

            .card-img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                border: none;
                box-shadow: none;
                background: transparent;
            }

            .close-btn,
            .modal-footer,
            button,
            .no-print {
                display: none !important;
            }
        }

        /* --- ì‚¬ìš©ì í•€ ì „ìš© ìŠ¤íƒ€ì¼ --- */
        #userPhotoDisplay {
            position: relative;
            cursor: crosshair;
            display: inline-block;
            width: 100%;
            background: #333;
            overflow: hidden;
        }

        #userPhotoDisplay img {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }

        .pin {
            position: absolute;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -100%);
            cursor: pointer;
            z-index: 30;
        }

        .pin .head {
            width: 14px;
            height: 14px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
            margin: 0 auto;
        }

        .pin .stem {
            width: 2px;
            height: 12px;
            background: #b91c1c;
            margin: 0 auto;
            transform: translateY(-2px);
        }

        .editor-popup {
            position: absolute;
            width: 220px;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            padding: 10px;
            z-index: 100;
            border-radius: 8px;
        }

        .editor-popup textarea {
            width: 100%;
            height: 60px;
            resize: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 5px;
            font-family: inherit;
        }

        .editor-btns {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .editor-btns button {
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ccc;
            font-size: 12px;
        }

        .btn-save-pin {
            background: #22c55e;
            color: white;
            border-color: #16a34a;
        }

        .btn-cancel-pin {
            background: white;
            color: #333;
        }

        .btn-del-pin {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
            margin-right: auto;
        }

        #toast-msg {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 15px;
            position: fixed;
            z-index: 10000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }

        #toast-msg.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* [ì‹ ê·œ] ë™ë£Œ ë¶„ì„ ë§í¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .peer-badge {
            background: white;
            border: 1px solid #0ea5e9;
            color: #0284c7;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
        }
        .peer-badge:hover {
            background: #0ea5e9;
            color: white;
        }

        /* [ì‹ ê·œ] ë“œë˜ê·¸ ê°€ëŠ¥í•œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .draggable-modal {
            position: fixed;
            top: 20%;
            left: 20%; /* ì´ˆê¸° ìœ„ì¹˜ */
            width: 300px;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-radius: 8px;
            z-index: 99999; /* ìµœìƒìœ„ */
            overflow: hidden;
        }
        .draggable-header {
            padding: 10px;
            cursor: move; /* ì´ë™ ì»¤ì„œ */
            background: #475569;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .modal-body-scroll {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.5;
        }
    </style>
</head>

<body>

    <nav class="mode-selector">
        <button class="mode-btn btn-admin-nav" onclick="switchMode('admin')">ğŸ” ê´€ë¦¬ì ëª¨ë“œ</button>
        <button class="mode-btn btn-user-nav active" onclick="switchMode('user')">ğŸ‘¤ ë¶„ì„ì ëª¨ë“œ</button>
    </nav>

    <div class="container">
        <div id="adminView" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:var(--admin-color); margin:0;">ğŸ› ï¸ ê´€ë¦¬ì íŒ¨ë„</h2>                
                <button class="btn btn-d" onclick="logoutAdmin()" style="padding:5px 15px; font-size:0.8rem;">ğŸ”’
                    ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div style="margin-bottom:10px;">
                <h3>ğŸ“¸ ì ê²€ ëŒ€ìƒ ì‚¬ì§„ ê´€ë¦¬ (ì—¬ëŸ¬ ì¥ ë“±ë¡ ê°€ëŠ¥)</h3>
                <div id="adminGallery" style="display:flex; gap:10px; overflow-x:auto; padding:10px; background:#f1f5f9; border-radius:8px; min-height:120px; align-items:center;">
                    <span style="color:#666; width:100%; text-align:center;">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</span>
                </div>
            </div>

            <div style="display:flex; gap:10px; justify-content: center; margin-bottom: 20px;">
                <video id="video" autoplay playsinline style="display:none; width:100%; max-height:300px;"></video>
                <input type="file" id="fileInput" hidden accept="image/*">
                
                <button class="btn btn-a" onclick="document.getElementById('fileInput').click()">â• ì‚¬ì§„ ì¶”ê°€ (íŒŒì¼)</button>
                <button class="btn btn-a" onclick="startCamera()">ğŸ“· ì¹´ë©”ë¼ ì¼œê¸°</button>
                <button class="btn btn-d" id="captureBtn" onclick="takePhotoAndAdd()" style="display:none">ğŸ“¸ ì´¬ì˜ ë° ì¶”ê°€</button>
            </div>

            <hr>
            <div
                style="background:#fefce8; padding:10px; border-radius:8px; border:1px solid #fef08a; margin-top:20px;">
                <label>ğŸ“… <strong>ì¡°íšŒ ê¸°ê°„ ì„¤ì •:</strong></label><br>
                <input type="date" id="startDate" onchange="updateAdminTable()"> ~
                <input type="date" id="endDate" onchange="updateAdminTable()">
                <button class="btn btn-p" onclick="selectAll(true)"
                    style="padding:5px 10px; font-size:0.8rem;">ì „ì²´ì„ íƒ</button>
                <button class="btn btn-a" onclick="selectAll(false)"
                    style="padding:5px 10px; font-size:0.8rem;">ì „ì²´ì„ íƒì·¨ì†Œ</button>

                <button id="analyzeBtn" class="btn" onclick="handleAnalyzeClick()" disabled
                    style="background:#059669; padding:5px 15px; font-size:0.8rem; margin-left:10px; opacity:0.5;">
                    ìœ ì‚¬ í•­ëª© ë¶„ì„
                </button>
                <button id="mainCompleteBtn" class="btn" onclick="showSavedReportModal()"
                    style="background:#1e293b; padding:5px 15px; font-size:0.8rem; margin-left:5px; display:none;">
                    ì¬ê·¸ë£¹ ì™„ë£Œ ìë£Œ
                </button>
                <button id="resetSimBtn" class="btn" onclick="resetReGroup()"
                    style="display:none; background:#64748b; padding:5px 15px; font-size:0.8rem; margin-left:5px;">
                    ì¬ê·¸ë£¹ ì´ˆê¸°í™”
                </button>
                <input type="file" id="jsonLoader" hidden accept=".json">
                <button id="loadBtn" class="btn" onclick="document.getElementById('jsonLoader').click()"
                    style="background:#d97706; padding:5px 15px; font-size:0.8rem; margin-left:5px;">
                    ë¶„ì„ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>

            <table id="adminTable">
                <thead>
                    <tr>
                        <th style="width: 25px;text-align:center;">âœ…</th>
                        <th style="width: 100px;text-align:center;">ë‚ ì§œ</th>
                        <th style="width: 70px;text-align:center;">ì´ë¦„</th>
                        <th style="width: 90px;text-align:center;">ì†Œì†</th>
                        <th style="width: 60px;text-align:center;">ì‚¬ì§„</th>
                        <th style="text-align:center;">ë¬¸ì œì </th>
                        <th style="width: 30px; text-align:center;">â›”</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div style="text-align: center; margin-top: 20px;">
                <p id="countDisplay" style="font-size: 1.1rem;">ì¡°íšŒ ê±´ìˆ˜: <strong>0</strong>ê°œ</p>
                <button class="btn btn-p" onclick="printAll()" style="font-size:1.2rem; width:100%;">ğŸ–¨ï¸ ì„ íƒ í•­ëª© í¬ìŠ¤íŠ¸ ì‡
                    ì¶œë ¥</button>
            </div>
        </div>

        <div id="userView" class="view-section active">
            <h2 style="color:var(--primary)">ğŸ“ ì•ˆì „ë³´ê±´ìƒì— ë¬¸ì œê°€ ìˆëŠ” ê³³ ëª¨ë‘ì— í´ë¦­í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”.</h2>

            <div style="text-align:right; margin-bottom:10px;">                
                <input type="file" id="userJsonLoad" hidden accept=".json">
                <button class="btn" style="background:#475569; padding:5px 10px; font-size:13px;"
                    onclick="document.getElementById('userJsonLoad').click()">ğŸ“‚ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°(ìˆ˜ì • ê°€ëŠ¥)</button>
            </div>
            <div id="userGalleryView">
                <h3 style="text-align:center; color:#555;">ğŸ‘‡ ì ê²€í•  í˜„ì¥ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</h3>
                <div id="userGallery" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:15px; padding:10px;">
                    </div>
            </div>

            <div id="userWorkView" style="display:none; text-align:center;">
                <button class="btn" onclick="showUserGallery()" style="margin-bottom:10px; background:#64748b;">â¬… ë‹¤ë¥¸ ì‚¬ì§„ ì„ íƒí•˜ê¸°</button>
                <div class="photo-display" id="userPhotoDisplay" onclick="handleImageClick(event)">
                    </div>
                <span style="font-size:14px;color: red;font-weight: 600; display:block; margin-top:10px;">â€» ë¬¸ì œì  ì…ë ¥ì˜ˆì‹œ : ë³´í˜¸êµ¬ ì°©ìš© ë¶ˆëŸ‰, ì •ë¦¬ì •ëˆ ìƒíƒœ ë¯¸í¡, ì»¨ë² ì´ì–´ ë¹„ìƒì •ì§€ ì¥ì¹˜ ë¯¸ì„¤ì¹˜ ë“±</span>

                <div id="peerLinksContainer" style="margin-top:10px; padding:10px; background:#f0f9ff; border-radius:8px; border:1px solid #bae6fd; text-align:left; display:none;">
                    <div style="font-size:12px; color:#0284c7; font-weight:bold; margin-bottom:5px;">ğŸ’¡ ë‹¤ë¥¸ ë™ë£Œë“¤ì˜ ë¶„ì„ ê²°ê³¼ ì°¸ê³ í•˜ê¸° (í´ë¦­):</div>
                    <div id="peerLinks" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>                
            </div>

            <div class="card" style="margin-top:15px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                    <input type="text" id="userName" placeholder="ì´ë¦„ (ì˜ˆ, í™ê¸¸ë™)">
                    <input type="text" id="userOrg" placeholder="ê¸°ê´€/ì†Œì† ë“± íšŒì‚¬ëª…(ì˜ˆ, (ì£¼)XYZ)">
                </div>
                <div id="tagContainer" style="min-height:30px;"></div>
                <button class="btn btn-p" onclick="submitEntry()"
                    style="width:100%; margin-top:15px; background:#16a34a; font-size:15px;">ë“±ë¡í•˜ê¸° <br><span
                        style="font-size:11px;color:yellow;">â€» ì°¾ìœ¼ì‹  ë¬¸ì œì ì´ ë“±ë¡ë©ë‹ˆë‹¤. ì…ë ¥í•˜ì‹  ìë£ŒëŠ” ìë™ ì €ì¥ë˜ì–´ ë¶ˆëŸ¬ì™€ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </span></button>
            </div>
        </div>
    </div>

    <div id="peerModal" class="draggable-modal" style="display:none;">
        <div id="peerModalHeader" class="draggable-header">
            <span id="peerModalTitle">ì°¸ê³  ìë£Œ</span>
            <button onclick="closePeerModal()" style="float:right; background:none; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>
        </div>
        <div id="peerModalContent" class="modal-body-scroll">
            </div>
    </div>

    <div id="analysisModal" class="modal-overlay">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px;">
                <h2 id="modalTitle" style="margin:0;">ğŸ“Š ìœ ì‚¬ í•­ëª© ë¶„ì„ ê²°ê³¼ (AI)</h2>
                <button onclick="closeModal()"
                    style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="analysisResultBody"></div>
            <div id="modalFooter" style="text-align:right; margin-top:20px;">
                <button id="saveReGroupBtn" class="btn" style="background:#0891b2; display:none;"
                    onclick="saveReGroupedData()">ğŸ’¾ ì¬ê·¸ë£¹ í•­ëª© ì €ì¥</button>
                <button class="btn btn-d" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="printLayer"></div>

    <script>
        let entryList = []; // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ëŒ€ì‹  ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘
        let mainPhoto = null;
        let currentUserPhoto = null;
        let pinIssues = [];
        let isAdminAuthenticated = false;
        let savedAnalysisReport = null;
        let analyzedNames = "";
        let activeEditor = null;
        let tempIssues = []; // ì‚¬ìš©ì ì…ë ¥ ì„ì‹œ ì €ì¥ìš©

        /* [ìˆ˜ì •] ì‹œì‘ ì‹œ ë‚ ì§œ ì œí•œì„ í’€ì–´ì„œ ì „ì²´ ëª©ë¡ ë³´ì—¬ì£¼ê¸° */
        window.onload = async () => {
            await loadGalleryFromDB(); // 1. ê°¤ëŸ¬ë¦¬ ë¡œë”©
            await loadDataFromDB();    // 2. ë°ì´í„° ë¡œë”©
            
            // ë‚ ì§œ ì…ë ¥ì°½ì„ ì¼ë¶€ëŸ¬ ë¹„ì›Œë‘¡ë‹ˆë‹¤. (ë¹„ì›Œë‘ë©´ ì „ì²´ ê¸°ê°„ ì¡°íšŒë¨)
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            updateAdminTable(); // í…Œì´ë¸” ê°±ì‹ 
        };

        // [ì‹ ê·œ] DBì—ì„œ ë°ì´í„° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadDataFromDB() {
            try {
                const { db, collection, getDocs, query, orderBy } = window.fs;
                const q = query(collection(db, "inspections"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                entryList = [];
                querySnapshot.forEach((doc) => {
                    // DBë¬¸ì„œ ID(dbId)ë¥¼ í¬í•¨í•˜ì—¬ ì €ì¥
                    entryList.push({ dbId: doc.id, ...doc.data() });
                });
                updateAdminTable();
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
                // showToast("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); // showToast ì •ì˜ ì „ì´ë©´ consoleë§Œ
            }
        }

        // [ì‹ ê·œ] DBì—ì„œ ê³µìš© ì‚¬ì§„(ë°°ê²½) ë¶ˆëŸ¬ì˜¤ê¸° (ì„¤ì • ì»¬ë ‰ì…˜ ì‚¬ìš©)
        async function loadMainPhotoFromDB() {
            try {
                const { db, doc, getDoc } = window.fs;
                const docRef = doc(db, "settings", "main_photo");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const src = docSnap.data().image;
                    mainPhoto = src;
                    currentUserPhoto = src;
                    renderAdminPhoto(src);
                    renderUserPhoto(src);
                }
            } catch (e) {
                console.log("ê³µìš© ì‚¬ì§„ ì—†ìŒ ë˜ëŠ” ë¡œë“œ ì‹¤íŒ¨");
            }
        }

        function switchMode(mode) {
            if (mode === 'admin') {
                if (!isAdminAuthenticated) {
                    const password = prompt("ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                    if (password === ADMIN_PASSWORD) { isAdminAuthenticated = true; }
                    else { showToast("ğŸš« ì•”í˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
                }
            }
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if (mode === 'admin') {
                document.getElementById('adminView').classList.add('active');
                document.querySelector('.btn-admin-nav').classList.add('active');
                updateAdminTable();
            } else {
                document.getElementById('userView').classList.add('active');
                document.querySelector('.btn-user-nav').classList.add('active');
            }
        }

        function logoutAdmin() {
            if (confirm("ê´€ë¦¬ì ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ê³  ì‚¬ìš©ì ëª¨ë“œë¡œ ëŒì•„ê°‘ë‹ˆê¹Œ?")) {
                isAdminAuthenticated = false;
                switchMode('user');
            }
        }

        function renderAdminPhoto(src) {
            document.getElementById('adminPhotoDisplay').innerHTML = `<img src="${src}">`;
        }

        function renderUserPhoto(src) {
            const container = document.getElementById('userPhotoDisplay');
            container.innerHTML = `<img src="${src}">`;
            const img = container.querySelector('img');
            img.onload = () => renderPins();
            if (img.complete) renderPins();
        }

        async function setMainPhoto(src) {
            mainPhoto = src;
            currentUserPhoto = src;
            renderAdminPhoto(src);
            renderUserPhoto(src);

            // [ë³€ê²½] DBì˜ 'settings' ì»¬ë ‰ì…˜ì— ê³µìš© ì‚¬ì§„ ì €ì¥
            try {
                const { db, doc, setDoc } = window.fs;
                // 'settings' ì»¬ë ‰ì…˜ì˜ 'main_photo' ë¬¸ì„œì— ë®ì–´ì“°ê¸°
                await setDoc(doc(db, "settings", "main_photo"), { image: src });
                // showToast("ğŸ“· ê³µìš© ì‚¬ì§„ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                console.error("ì‚¬ì§„ ì €ì¥ ì‹¤íŒ¨:", e);
                alert("ì‚¬ì§„ ì„œë²„ ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ì´ ë„ˆë¬´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            }
        }

        function handleImageClick(e) {
            if (e.target.closest('.pin') || e.target.closest('.editor-popup')) return;
            const container = document.getElementById('userPhotoDisplay');
            const rect = container.getBoundingClientRect();
            const xPct = ((e.clientX - rect.left) / rect.width) * 100;
            const yPct = ((e.clientY - rect.top) / rect.height) * 100;
            openEditor(xPct, yPct, null);
        }

        function openEditor(xPct, yPct, existingPinId) {
            closeEditor();
            const container = document.getElementById('userPhotoDisplay');
            const editor = document.createElement('div');
            editor.className = 'editor-popup';
            let currentText = '';
            let delBtn = '';
            if (existingPinId) {
                const pin = pinIssues.find(p => p.id === existingPinId);
                currentText = pin ? pin.text : '';
                delBtn = `<button class="btn-del-pin" onclick="deletePin(${existingPinId})">ì‚­ì œ</button>`;
            }

            editor.innerHTML = `
                <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ë¬¸ì œì  ì…ë ¥</div>
                <textarea id="tempText">${currentText}</textarea>
                <div class="editor-btns">${delBtn} <button class="btn-cancel-pin" onclick="closeEditor()">ì·¨ì†Œ</button>
                <button class="btn-save-pin" onclick="savePinData(${xPct}, ${yPct}, ${existingPinId})">ì €ì¥</button></div>`;

            // ìœ„ì¹˜ ìë™ ì¡°ì •
            if (yPct > 50) { editor.style.bottom = `calc(${100 - yPct}% + 15px)`; editor.style.top = 'auto'; }
            else { editor.style.top = `calc(${yPct}% + 15px)`; editor.style.bottom = 'auto'; }
            if (xPct > 80) { editor.style.right = `calc(${100 - xPct}%)`; editor.style.left = 'auto'; }
            else { editor.style.left = xPct + '%'; editor.style.right = 'auto'; }

            container.appendChild(editor);
            activeEditor = editor;
            setTimeout(() => document.getElementById('tempText').focus(), 50);
        }

        function savePinData(x, y, id) {
            let val = document.getElementById('tempText').value.trim().replace(/\r?\n/g, ', ');
            if (!val) return;
            if (id) { const p = pinIssues.find(i => i.id === id); if (p) p.text = val; }
            else { pinIssues.push({ id: Date.now(), x, y, text: val }); }
            closeEditor(); renderPins(); renderUserTags();
        }

        function closeEditor() { if (activeEditor) { activeEditor.remove(); activeEditor = null; } }
        function deletePin(id) { pinIssues = pinIssues.filter(p => p.id !== id); closeEditor(); renderPins(); renderUserTags(); }

        function renderPins() {
            const container = document.getElementById('userPhotoDisplay');
            container.querySelectorAll('.pin').forEach(el => el.remove());
            pinIssues.forEach(pin => {
                const el = document.createElement('div');
                el.className = 'pin'; el.style.left = pin.x + '%'; el.style.top = pin.y + '%';
                el.title = pin.text; el.innerHTML = `<div class="head"></div><div class="stem"></div>`;
                el.onclick = (e) => { e.stopPropagation(); openEditor(pin.x, pin.y, pin.id); };
                container.appendChild(el);
            });
        }

        function renderUserTags() {
            const container = document.getElementById('tagContainer');
            container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            if (pinIssues.length === 0) {
                container.innerHTML = '<span style="color:#999; font-size:0.8rem;">ì´ê³³ì—ëŠ” ì…ë ¥í•œ ë¬¸ì œì ì´ ë‚˜ì—´ë©ë‹ˆë‹¤.</span>';
                return;
            }

            // [ìˆ˜ì • í•µì‹¬] ë¬¸ìì—´ ì¡°í•© ëŒ€ì‹  DOM ìš”ì†Œë¥¼ ì§ì ‘ ìƒì„±í•˜ì—¬ ì¢Œí‘œ ë°ì´í„°(p.x, p.y)ì˜ ì •ë°€ë„ ì†ì‹¤ ë°©ì§€
            pinIssues.forEach(p => {
                const span = document.createElement('span');
                span.style.cssText = "display:inline-block; background:white; border:1px solid var(--primary); padding:5px 12px; border-radius:15px; margin-right:8px; margin-bottom:8px; font-size:0.8rem; color:var(--primary); cursor:pointer; font-weight:500; box-shadow: 1px 1px 3px rgba(0,0,0,0.1);";
                span.innerText = `ğŸ“Œ ${p.text}`;

                // í´ë¦­ ì´ë²¤íŠ¸ì— ì›ë³¸ ë°ì´í„°ì˜ ì¢Œí‘œë¥¼ ì§ì ‘ ì „ë‹¬ (ë¬¸ìì—´ ë³€í™˜ ê³¼ì • ì œê±°)
                span.onclick = (e) => {
                    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ê°€ í•„ìš”í•  ê²½ìš° ì¶”ê°€
                    if (e) e.stopPropagation();
                    openEditor(p.x, p.y, p.id);
                };

                container.appendChild(span);
            });
        }

        async function submitEntry() { // async ì¶”ê°€
            const nameEl = document.getElementById('userName');
            const orgEl = document.getElementById('userOrg');
            const name = nameEl.value.trim();
            const org = orgEl.value.trim();

            if (!name || pinIssues.length === 0) {
                return showToast("ì´ë¦„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            }

            // 1. ì¤‘ë³µ ê²€ì‚¬ (ì´ë¦„, ì†Œì†, ì‚¬ì§„ ì¼ì¹˜ ì—¬ë¶€)
            // entryListëŠ” loadDataFromDB()ë¡œ í•­ìƒ ìµœì‹  ìƒíƒœì—¬ì•¼ í•¨
            const duplicateItem = entryList.find(item =>
                item.name === name &&
                item.org === org &&
                item.photo === currentUserPhoto
            );

            // 2. ì €ì¥í•  ë°ì´í„° ê°ì²´ ì¤€ë¹„
            const newEntry = {
                id: Date.now(), // íƒ€ì„ìŠ¤íƒ¬í”„ ID (êµ¬ë¶„ìš©)
                timestamp: new Date().getTime(),
                name,
                org,
                issues: pinIssues.map(p => p.text),
                pins: [...pinIssues],
                photo: currentUserPhoto
            };

            let isUpdate = false;
            let targetDbId = null;

            // 3. ì¤‘ë³µ ì²˜ë¦¬ (ë®ì–´ì“°ê¸° ë¡œì§)
            if (duplicateItem) {
                if (!confirm("ì´ë¯¸ ë“±ë¡ëœ ìë£Œì…ë‹ˆë‹¤.\nê¸°ì¡´ ë‚´ìš©ì„ 'ìˆ˜ì •(ë®ì–´ì“°ê¸°)' í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }
                isUpdate = true;
                targetDbId = duplicateItem.dbId; // ê¸°ì¡´ DB ë¬¸ì„œ ID ì‚¬ìš©
                newEntry.id = duplicateItem.id;  // ê¸°ì¡´ ë‚´ë¶€ ID ìœ ì§€
            }

            // 4. Firebase DB ì €ì¥ ì‹¤í–‰
            showToast("â³ ì„œë²„ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...");

            try {
                const { db, collection, addDoc, doc, setDoc } = window.fs;

                if (isUpdate) {
                    // [ìˆ˜ì •] ê¸°ì¡´ ë¬¸ì„œ ë®ì–´ì“°ê¸°
                    await setDoc(doc(db, "inspections", targetDbId), newEntry);
                } else {
                    // [ì‹ ê·œ] ìƒˆ ë¬¸ì„œ ì¶”ê°€
                    await addDoc(collection(db, "inspections"), newEntry);
                }

                // ì €ì¥ í›„ ëª©ë¡ ê°±ì‹  (ì¤‘ìš”)
                await loadDataFromDB();

                // [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ëª… ë‚ ì§œ í˜•ì‹ ì§€ì • (YYYYMMDD_HHMMSS)
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const second = String(now.getSeconds()).padStart(2, '0');

                // ì˜ˆ: ì•ˆì „ì ê²€_í™ê¸¸ë™_20260128_151637.json
                const fileName = `ì•ˆì „ì ê²€_${name}_${year}${month}${day}_${hour}${minute}${second}.json`;

                const blob = new Blob([JSON.stringify(newEntry, null, 2)], { type: "application/json" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                a.click();


                // 6. ë§ˆë¬´ë¦¬
                nameEl.value = '';
                orgEl.value = '';
                pinIssues = [];

                // ì‚¬ì§„ ì´ˆê¸°í™” (ê´€ë¦¬ì ì‚¬ì§„ìœ¼ë¡œ ë³µê·€)
                if (mainPhoto && currentUserPhoto !== mainPhoto) {
                    currentUserPhoto = mainPhoto;
                    renderUserPhoto(mainPhoto);
                } else {
                    renderPins();
                }
                renderUserTags();

                if (isUpdate) showToast("â™»ï¸ ê¸°ì¡´ ë‚´ìš©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                else showToast("âœ… ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");

            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
        }


        /* [ìˆ˜ì •] íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° + ìœ íš¨ì„± ê²€ì‚¬(í˜•ì‹ í™•ì¸) ì¶”ê°€ */
        document.getElementById('userJsonLoad').onchange = function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = (evt) => {
                try {
                    const data = JSON.parse(evt.target.result);

                    // ğŸ›¡ï¸ [ìœ íš¨ì„± ê²€ì‚¬ 1] í•„ìˆ˜ ë°ì´í„°(ì‚¬ì§„)ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (!data.photo || typeof data.photo !== 'string') {
                        alert("â›” ì˜¬ë°”ë¥¸ ì ê²€ íŒŒì¼ ì–‘ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\n(ì‚¬ì§„ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.)");
                        this.value = ''; // ì´ˆê¸°í™”
                        return;
                    }

                    // ğŸ›¡ï¸ [ìœ íš¨ì„± ê²€ì‚¬ 2] í•„ìˆ˜ ë°ì´í„°(í•€ ëª©ë¡)ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (!data.pins || !Array.isArray(data.pins)) {
                        alert("â›” ì˜¬ë°”ë¥¸ ì ê²€ íŒŒì¼ ì–‘ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.\n(ë¬¸ì œì  ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.)");
                        this.value = ''; 
                        return;
                    }

                    // --- ê²€ì‚¬ í†µê³¼ ì‹œ ë°ì´í„° ë¡œë“œ ì§„í–‰ ---
                    
                    // ì €ì¥ëœ ì‚¬ì§„ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´ (ì••ì¶• ì—†ì´)
                    currentUserPhoto = data.photo;

                    document.getElementById('userName').value = data.name || data.userName || '';
                    document.getElementById('userOrg').value = data.org || data.userOrg || '';
                    pinIssues = data.pins || [];

                    // ê°¤ëŸ¬ë¦¬ ë·° ìˆ¨ê¸°ê³  ì‘ì—… í™”ë©´ìœ¼ë¡œ ì „í™˜
                    document.getElementById('userGalleryView').style.display = 'none';
                    document.getElementById('userWorkView').style.display = 'block';

                    if (currentUserPhoto) {
                        renderUserPhoto(currentUserPhoto);
                    }
                    
                    if (typeof renderUserTags === 'function') renderUserTags();
                    
                    // (ì„ íƒ) ë¶ˆëŸ¬ì˜¨ ì‚¬ì§„ì— ëŒ€í•œ ë™ë£Œë“¤ì˜ ë¶„ì„ ê²°ê³¼ë„ ê°™ì´ ë¶ˆëŸ¬ì˜¤ê¸°
                    if (typeof loadPeerReviews === 'function') loadPeerReviews(currentUserPhoto);

                    showToast("ğŸ“‚ ì ê²€ íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");

                } catch (err) {
                    console.error(err);
                    alert("âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }
            };
            reader.readAsText(file);
            this.value = '';
        };

        function updateAdminTable() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            const filtered = entryList.filter(item => {
                // [ìˆ˜ì • 1] ë‚ ì§œ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ (RangeError í•´ê²° í•µì‹¬)
                if (!item.timestamp || isNaN(new Date(item.timestamp).getTime())) {
                    return false;
                }

                const d = new Date(item.timestamp).toISOString().split('T')[0];
                return (!start || d >= start) && (!end || d <= end);
            });

            const tbody = document.querySelector('#adminTable tbody');

            // [ìˆ˜ì • 2] ì‚¬ì§„ì´ ì—†ìœ¼ë©´ ê´€ë¦¬ì ë°°ê²½(mainPhoto) í‘œì‹œ
            tbody.innerHTML = filtered.map(item => `
        <tr>
            <td><input type="checkbox" class="row-check" data-id="${item.id}" onchange="updateCounter()"></td>
            <td>${new Date(item.timestamp).toLocaleString()}</td>
            <td>${item.name}</td><td>${item.org}</td>
            <td><img src="${item.photo || mainPhoto}" class="thumb-img" onclick="window.open(this.src)"></td>
            <td>${item.issues.join('<br>')}</td>
            <td><button onclick="deleteItem(${item.id})">â›”</button></td>
        </tr>`).join('');

            updateCounter();
        }

        function updateCounter() {
            const cnt = document.querySelectorAll('.row-check:checked').length;
            document.getElementById('analyzeBtn').disabled = cnt < 2;
            document.getElementById('analyzeBtn').style.opacity = cnt < 2 ? '0.5' : '1';
            document.getElementById('countDisplay').innerText = `ì„ íƒ: ${cnt}ê°œ`;
        }

        function selectAll(bool) { document.querySelectorAll('.row-check').forEach(c => c.checked = bool); updateCounter(); }
        async function deleteItem(id) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) return;

            // idì™€ ì¼ì¹˜í•˜ëŠ” í•­ëª© ì°¾ê¸° (dbIdê°€ í•„ìš”í•¨)
            const target = entryList.find(item => item.id === id);
            if (!target || !target.dbId) return alert("í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            try {
                const { db, doc, deleteDoc } = window.fs;
                await deleteDoc(doc(db, "inspections", target.dbId));

                // ëª©ë¡ ê°±ì‹ 
                await loadDataFromDB();
                showToast("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        }


        function printAll() {
            const checked = Array.from(document.querySelectorAll('.row-check:checked')).map(c => Number(c.dataset.id));
            const targets = entryList.filter(i => checked.includes(i.id));
            const layer = document.getElementById('printLayer');
            layer.innerHTML = targets.map(e => `
                <div class="post-it-card">
                    <div class="card-header"><h3>${e.name} (${e.org})</h3></div>
                    <div class="card-body">${e.issues.map(is => `<div>- ${is}</div>`).join('')}</div>
                    <div class="card-img-box"><img src="${e.photo}" class="card-img"></div>
                </div>`).join('');
            window.print();
        }

        async function handleAnalyzeClick() {
            const checkedIds = Array.from(document.querySelectorAll('.row-check:checked')).map(c => Number(c.dataset.id));
            const selected = entryList.filter(it => checkedIds.includes(it.id));
            const resultBody = document.getElementById('analysisResultBody');

            if (selected.length < 2) {
                showToast("âš ï¸ ë¶„ì„í•˜ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            const uniqueNames = [...new Set(selected.map(item => item.name))];
            analyzedNames = uniqueNames.join(', ') + "ë‹˜ê»˜ì„œ ì°¾ìœ¼ì‹  ë¬¸ì œì ì…ë‹ˆë‹¤.";

            document.getElementById('modalTitle').innerText = "ğŸ›¡ï¸ AIë¥¼ í†µí•œ ìœ ì‚¬ë„ ì •ë°€ ë¶„ì„ ê²°ê³¼";
            document.getElementById('analysisModal').style.display = 'flex';
            resultBody.innerHTML = `<div style="text-align:center; padding:30px;"><div class="loading-spinner"></div><p>H-ACD ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;

            try {
                // 1. ë°ì´í„° ì¤€ë¹„
                let flattened = [];
                selected.forEach(s => {
                    s.issues.forEach(txt => {
                        // [í•µì‹¬ ìˆ˜ì •] ì½¤ë§ˆ(,)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ì¥ì„ ìª¼ê°­ë‹ˆë‹¤.
                        // ì˜ˆ: "ì•ˆì „ëª¨ ë¯¸ì°©ìš©, ì „ì„  ë…¸ì¶œ" -> ["ì•ˆì „ëª¨ ë¯¸ì°©ìš©", "ì „ì„  ë…¸ì¶œ"]
                        const splitItems = txt.split(',').map(t => t.trim()).filter(t => t.length > 0);

                        // ìª¼ê°œì§„ ê°ê°ì˜ í•­ëª©ì„ ë¶„ì„ ëŒ€ìƒìœ¼ë¡œ ë“±ë¡
                        splitItems.forEach(splitText => {
                            flattened.push({ text: splitText, name: s.name });
                        });
                    });
                });

                // 2. ì„¤ì • ë° ìš©ì–´ì§‘ ì¤€ë¹„ (ìƒëµ ì—†ì´ ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                const STEP_WEIGHTS = [0.45, 0.35, 0.20];
                let externalJson = [];
                try {
                    const response = await fetch('ì•ˆì „ë³´ê±´ ìš©ì–´.json');
                    if (response.ok) externalJson = await response.json();
                } catch (e) { console.log("ì™¸ë¶€ JSON ì—†ìŒ, ë‚´ì¥ Categoriesë§Œ ì‚¬ìš©"); }

                const Categories = {
                    "ë³´í˜¸êµ¬/PPE": ["ì•ˆì „ëª¨", "ê·€ë§ˆê°œ", "ì•ˆì „í™”", "ì•ˆì „ëŒ€", "ë³´ì•ˆê²½", "ë§ˆìŠ¤í¬", "ì¥ê°‘", "ì¡°ë¼", "í—¬ë©§", "ê·€ë®ê°œ", "ë³´í˜¸êµ¬", "PPE", "ë°©ì§„ë§ˆìŠ¤í¬", "ë³´ì•ˆë©´", "ì•ˆì „ì¥êµ¬", "ì•ì¹˜ë§ˆ", "ì»¤ë²„"],
                    "ìœ„í—˜ì„±í‰ê°€/í™œë™": ["ìœ„í—˜ì„±í‰ê°€", "TBM", "ì ê²€", "ìˆœì°°", "í˜„ì¥í™•ì¸", "ìœ í•´ìœ„í—˜ìš”ì¸", "ëŒ€ì±…", "ê°œì„ ", "ì•ˆì „í™œë™", "í™œë™"],
                    "êµìœ¡/í–‰ì •": ["ì•ˆì „êµìœ¡", "ì •ê¸°êµìœ¡", "íŠ¹ë³„êµìœ¡", "ìˆ˜ì¹™", "êµìœ¡", "ì±„ìš©ì‹œêµìœ¡", "ì‘ì—…ë‚´ìš©ë³€ê²½ì‹œêµìœ¡", "ë³´ê±´êµìœ¡"],
                    "ê·¼ê³¨ê²©ê³„/ìš´ë°˜": ["ê·¼ê³¨ê²©ê³„", "ìš”í†µ", "ì¤‘ëŸ‰ë¬¼", "ì¸ë ¥ìš´ë°˜", "ìƒí•˜ì°¨", "ì ì¬", "ì¹´íŠ¸", "ìš´ë°˜ì‘ì—…", "ìŠ¤íŠ¸ë ˆì¹­", "í—ˆë¦¬", "ìš´ë°˜"],
                    "ì¶”ë½/ê³ ì†Œì‘ì—…": ["ë¹„ê³„", "ë°œíŒ", "ë‚œê°„", "ì‚¬ë‹¤ë¦¬", "ìš°ë§ˆ", "ê³ ì†Œì‘ì—…ëŒ€", "ì¶”ë½", "ìƒëª…ì¤„", "ê°œêµ¬ë¶€", "ë®ê°œ", "ë Œíƒˆ", "ìŠ¤ì¹´ì´", "ë°©í˜¸ì„ ë°˜"],
                    "ê±´ì„¤ê¸°ê³„/ì–‘ì¤‘": ["í¬ë ˆì¸", "ì§€ê²Œì°¨", "êµ´ì°©ê¸°", "ë¤í”„", "ë¦¬í”„íŠ¸", "í˜¸ì´ìŠ¤íŠ¸", "ìƒ¤í´", "ì¤„ê±¸ì´", "ìŠ¬ë§ë²¨íŠ¸", "í˜‘ì°©", "ì¶©ëŒ", "ë°±í˜¸", "í•­íƒ€ê¸°"],
                    "ì „ê¸°/ì—ë„ˆì§€": ["ë¶„ì „ë°˜", "ì ‘ì§€", "ì°¨ë‹¨ê¸°", "ì¼€ì´ë¸”", "ë³€ì••ê¸°", "ì ˆì—°", "ê°ì „", "í™œì„ ", "ë°°ì „ë°˜", "ì„ì‹œë™ë ¥", "ë¶„ì „í•¨"],
                    "í™”ê¸°/í­ë°œ": ["ì†Œí™”ê¸°", "ìš©ì ‘", "ì ˆë‹¨", "ê°€ìŠ¤", "ë¶ˆê½ƒë°©ì§€", "í™”ì¬", "í­ë°œ", "ì¸í™”ì„±", "ì‚°ì†Œí†µ", "ì§ˆì†Œ", "ì•„ì„¸í‹¸ë Œ", "í™”ê¸°"],
                    "ë°€í/ë³´ê±´": ["ë°€íê³µê°„", "í™˜ê¸°", "ì†¡í’ê¸°", "ì§ˆì‹", "í™©í™”ìˆ˜ì†Œ", "ê°€ìŠ¤ì¸¡ì •", "ë°°í’ê¸°", "ì‚°ì†Œë†ë„", "MSDS", "ìœ í•´í™”í•™ë¬¼ì§ˆ"],
                    "ì •ë¦¬/í™˜ê²½": ["ì •ë¦¬ì •ëˆ", "íê¸°ë¬¼", "ì²­ì†Œ", "ì‚´ìˆ˜", "ì„¸ë¥œ", "ë°©ì§„ë§‰", "ì²­ê²°", "ìì¬ì •ë¦¬", "í™˜ê²½", "ìœ„ìƒ"],
                    "êµí†µ/ìœ ë„": ["ì‹ í˜¸ìˆ˜", "ìœ ë„ì", "ê°ì‹œì›", "ë¼ë°”ì½˜", "ì•ˆì „í†µë¡œ", "ê²½ì‚¬ë¡œ", "ê³„ë‹¨", "íœìŠ¤", "ë°”ë¦¬ì¼€ì´ë“œ", "í†µë¡œ"],
                    "íœ´ë¨¼ì—ëŸ¬/ì¸ì ì˜¤ë¥˜": ["íœ´ë¨¼ì—ëŸ¬", "ì¸ì ì˜¤ë¥˜", "ì¸ì ì›ì¸", "ì‹¤ìˆ˜"],
                    "í˜‘ì°©": ["ë¼ì„", "ì••ì°©", "ë§ë¦¼"],
                    "ë–¨ì–´ì§": ["ì¶”ë½"],
                    "ë¯¸ë„ëŸ¬ì§": ["ì „ë„", "ë„˜ì–´ì§", "ë¯¸ë„ëŸ¼"],
                    "í™”í•™ë¬¼ì§ˆ/ìœ í•´ì¸ì": ["ê°€ìŠ¤", "ì‚°ì†Œ", "ì§ˆì†Œ", "ìˆ˜ì†Œ", "ì•”ëª¨ë‹ˆì•„", "ì¼ì‚°í™”íƒ„ì†Œ", "ì´ì‚°í™”íƒ„ì†Œ", "í™©í™”ìˆ˜ì†Œ", "ì—¼ì†Œ",
                        "ë²¤ì  ", "í†¨ë£¨ì—”", "ìì¼ë Œ", "ë‚˜íŠ¸ë¥¨", "ë§ˆê·¸ë„¤ìŠ˜", "ì¹¼ë¥¨", "ìˆ˜ì€", "ë‚©", "í¬ë¡¬", "ë‹ˆì¼ˆ", "ì¹´ë“œë®´",
                        "ì•„ì„¸í†¤", "ì‹œë„ˆ", "ì•Œì½”ì˜¬", "ë©”íƒ„ì˜¬", "ì—íƒ„ì˜¬", "í™©ì‚°", "ì§ˆì‚°", "ì—¼ì‚°", "ì¸ì‚°", "ë¶ˆì‚°", "ìœ ê¸°ìš©ì œ",
                        "MSDS", "ë¬¼ì§ˆì•ˆì „ë³´ê±´ìë£Œ", "ìœ í•´í™”í•™ë¬¼ì§ˆ", "ë…ì„±ë¬¼ì§ˆ", "ë°œì•”ì„±ë¬¼ì§ˆ", "ì¸í™”ì„±ë¬¼ì§ˆ", "ë¶€ì‹ì„±ë¬¼ì§ˆ",
                        "ì‚°í™”ì„±ë¬¼ì§ˆ", "í­ë°œì„±ë¬¼ì§ˆ", "ê¸ˆìˆ˜ì„±ë¬¼ì§ˆ", "ê°€ì—°ì„±ê°€ìŠ¤", "ìš©ì ‘í„", "ë¶„ì§„", "ë¯¸ìŠ¤íŠ¸", "ì¦ê¸°", "ì„ë©´"],
                    "ì§ì—…ë³‘/ì§ˆí™˜/ì˜ë£Œ": ["ë‚œì²­", "ì†ŒìŒì„±ë‚œì²­", "ì´ëª…", "ê·¼ê³¨ê²©ê³„", "ìš”í†µ", "ë””ìŠ¤í¬", "ê´€ì ˆì—¼", "ê±´ì´ˆì—¼", "ìˆ˜ê·¼ê´€ì¦í›„êµ°",
                        "ì§„íì¦", "ì„ë©´í", "ì²œì‹", "í”¼ë¶€ì—¼", "ì•„í† í”¼", "í™”ìƒ", "ë™ìƒ", "ì—´ì‚¬ë³‘", "ì—´ê²½ë ¨", "íƒˆì§„",
                        "ì¤‘ë…", "ì§ˆì‹", "ì‚°ì†Œê²°í•", "ë‡Œì‹¬í˜ˆê´€", "ë‡Œì¶œí˜ˆ", "ë‡Œê²½ìƒ‰", "ì‹¬ê·¼ê²½ìƒ‰", "í˜‘ì‹¬ì¦", "ê³ í˜ˆì••", "ë‹¹ë‡¨",
                        "ìŠ¤íŠ¸ë ˆìŠ¤", "ìš°ìš¸ì¦", "ë¶ˆë©´ì¦", "ê±´ê°•ì§„ë‹¨", "íŠ¹ìˆ˜ê±´ê°•ì§„ë‹¨", "ë°°ì¹˜ì „ê±´ê°•ì§„ë‹¨", "ì‘ê¸‰ì²˜ì¹˜", "ì‹¬íì†Œìƒìˆ "],
                    "ì „ê¸°/ê°ì „/ë°©í­": [
                        "ê°ì „", "ëˆ„ì „", "ì ‘ì§€", "ì ˆì—°", "ë‹¨ë½", "í•©ì„ ", "ê³¼ì „ë¥˜", "ê³¼ë¶€í•˜", "ì •ì „ê¸°", "ì „ì••", "ì „ë¥˜", "ì €í•­",
                        "ì°¨ë‹¨ê¸°", "ê°œíê¸°", "ë¶„ì „ë°˜", "ë°°ì „ë°˜", "ë³€ì••ê¸°", "ì¼€ì´ë¸”", "ì „ì„ ", "í”ŒëŸ¬ê·¸", "ì½˜ì„¼íŠ¸", "ìŠ¤ìœ„ì¹˜",
                        "ë°©í­", "ë‚´ì••ë°©í­", "ì•ˆì „ì¦ë°©í­", "ë³¸ì§ˆì•ˆì „", "í™œì„ ", "ê²€ì „ê¸°", "ì ˆì—°ì¥ê°‘", "ì ˆì—°í™”", "ë„ì „ë¶€", "ì¶©ì „ë¶€"
                    ],
                    "ê±´ì„¤/í† ëª©/ê°€ì„¤": [
                        "ë¹„ê³„", "ê°•ê´€ë¹„ê³„", "ì‹œìŠ¤í…œë¹„ê³„", "ë‹¬ë¹„ê³„", "ë§ë¹„ê³„", "ì´ë™ì‹ë¹„ê³„", "ì‘ì—…ë°œíŒ", "ê°€ì„¤í†µë¡œ", "ì‚¬ë‹¤ë¦¬",
                        "ê±°í‘¸ì§‘", "ë™ë°”ë¦¬", "í™ë§‰ì´", "ê°€ì‹œì„¤", "ì§€ë³´ê³µ", "êµ´ì°©", "í„°íŒŒê¸°", "ë°œíŒŒ", "í„°ë„", "ì˜¹ë²½", "ì¶•ëŒ€",
                        "ì„±í† ", "ì ˆí† ", "ê°œêµ¬ë¶€", "ë‹¨ë¶€", "ì¶”ë½", "ë¶•ê´´", "ë‚™í•˜", "ë§¤ì„¤ë¬¼", "ì§€ë°˜", "ì¹¨í•˜"
                    ],
                    "ê¸°ê³„/ì¥ë¹„/ì„¤ë¹„": [
                        "í”„ë ˆìŠ¤", "ì „ë‹¨ê¸°", "ì ˆê³¡ê¸°", "ì„ ë°˜", "ë°€ë§", "ì—°ì‚­ê¸°", "ë‘¥ê·¼í†±", "ì»¨ë² ì´ì–´", "ë²¨íŠ¸", "ë¡¤ëŸ¬", "ê¸°ì–´",
                        "íšŒì „ì²´", "í˜‘ì°©", "ë¼ì„", "ë§ë¦¼", "ë°©í˜¸ì¥ì¹˜", "ì•ˆì „ì¥ì¹˜", "ë¦¬ë¯¸íŠ¸ìŠ¤ìœ„ì¹˜", "ì¸í„°ë¡", "ê´‘ì „ìì‹", "ì–‘ìˆ˜ì¡°ì‘ì‹",
                        "ë³´ì¼ëŸ¬", "ì••ë ¥ìš©ê¸°", "ê³µê¸°ì••ì¶•ê¸°", "íŒí”„", "ë°°ê´€", "ë°¸ë¸Œ", "ì‚¬ì¶œê¸°", "ë¡œë´‡", "ì‚°ì—…ìš©ë¡œë´‡"
                    ],
                    "ìš´ë°˜/í•˜ì—­/ì–‘ì¤‘": [
                        "í¬ë ˆì¸", "íƒ€ì›Œí¬ë ˆì¸", "ì²œì •í¬ë ˆì¸", "ì´ë™ì‹í¬ë ˆì¸", "í˜¸ì´ìŠ¤íŠ¸", "ì§€ê²Œì°¨", "í™”ë¬¼ì°¨", "ë¤í”„íŠ¸ëŸ­",
                        "êµ´ì°©ê¸°", "í¬í¬ë ˆì¸", "ë¡œë”", "ë¦¬í”„íŠ¸", "ìŠ¹ê°•ê¸°", "ê³¤ëŒë¼", "ê³ ì†Œì‘ì—…ëŒ€", "ì–‘ì¤‘ê¸°", "ì¤„ê±¸ì´", "ìŠ¬ë§ë²¨íŠ¸",
                        "ì™€ì´ì–´ë¡œí”„", "ì²´ì¸", "ìƒ¤í´", "í›…", "í•´ì§€ì¥ì¹˜", "íŒ”ë ˆíŠ¸", "ì¤‘ëŸ‰ë¬¼", "ì¸ë ¥ìš´ë°˜"
                    ],
                    "í™”ì¬/í­ë°œ/ì†Œë°©": [
                        "í™”ì¬", "í­ë°œ", "ë°œí™”", "ì¸í™”", "ì—°ì†Œ", "ì†Œí™”ê¸°", "ì†Œí™”ì „", "ìŠ¤í”„ë§í´ëŸ¬", "ê°ì§€ê¸°", "ê²½ë³´ê¸°", "ëŒ€í”¼",
                        "í”¼ë‚œ", "ë¹„ìƒêµ¬", "ìœ ë„ë“±", "ë°©í™”ë²½", "ë°©í™”ë¬¸", "ë°©ìœ ì œ", "ì •ì „ê¸°", "ë¶ˆê½ƒ", "ìŠ¤íŒŒí¬", "ìš©ì ‘", "ìš©ë‹¨",
                        "í™”ê¸°ì‘ì—…", "ìì—°ë°œí™”", "ë¶„ì§„í­ë°œ", "ê°€ìŠ¤ëˆ„ì¶œ"
                    ],
                    "ë³´í˜¸êµ¬/ì•ˆì „ì¥êµ¬": [
                        "ì•ˆì „ëª¨", "ì•ˆì „í™”", "ì•ˆì „ëŒ€", "ì•ˆì „ë²¨íŠ¸", "ë³´ì•ˆê²½", "ë³´ì•ˆë©´", "ê·€ë§ˆê°œ", "ê·€ë®ê°œ", "ë°©ì§„ë§ˆìŠ¤í¬", "ë°©ë…ë§ˆìŠ¤í¬",
                        "ì†¡ê¸°ë§ˆìŠ¤í¬", "ê³µê¸°í˜¸í¡ê¸°", "ì•ˆì „ì¥ê°‘", "ë³´í˜¸ë³µ", "ë°©ì—´ë³µ", "ê°ë°˜", "ì•ˆì „ë¸”ë¡", "ì¶”ë½ë°©ì§€ëŒ€"
                    ],
                    "ì‘ì—…í™˜ê²½/ìœ„ìƒ/ì¸¡ì •": [
                        "ì‘ì—…í™˜ê²½ì¸¡ì •", "ì†ŒìŒ", "ì§„ë™", "ë¶„ì§„", "ì¡°ë„", "ì˜¨ë„", "ìŠµë„", "í™˜ê¸°", "êµ­ì†Œë°°ê¸°", "ì „ì²´í™˜ê¸°", "í›„ë“œ",
                        "ë•íŠ¸", "ì†¡í’ê¸°", "ë°€íê³µê°„", "ì‚°ì†Œë†ë„", "ìœ í•´ê°€ìŠ¤", "ê²€ì§€ê´€", "ì‹œë£Œì±„ì·¨", "ë…¸ì¶œê¸°ì¤€", "í—ˆìš©ê¸°ì¤€", "ì¾Œì "
                    ],
                    "ì•ˆì „ê´€ë¦¬/ì œë„/êµìœ¡": [
                        "ì‚°ì—…ì•ˆì „ë³´ê±´ë²•", "ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²•", "ìœ„í—˜ì„±í‰ê°€", "ì•ˆì „ê´€ë¦¬ì", "ë³´ê±´ê´€ë¦¬ì", "ê´€ë¦¬ê°ë…ì", "ì•ˆì „êµìœ¡",
                        "íŠ¹ë³„êµìœ¡", "ì •ê¸°êµìœ¡", "ì±„ìš©ì‹œêµìœ¡", "TBM", "íˆ´ë°•ìŠ¤ë¯¸íŒ…", "ì•ˆì „ì ê²€", "ì•ˆì „ìˆœì°°", "ì§€ì í™•ì¸", "ì•„ì°¨ì‚¬ê³ ",
                        "ë¬´ì¬í•´", "í‘œì§€íŒ", "ê²½ê³ í‘œì§€", "ì•ˆì „ìˆ˜ì¹™", "ì‘ì—…í—ˆê°€ì„œ", "ì•ˆì „ì¸ì¦", "ê²€ì‚¬", "ì¸í—ˆê°€"
                    ],
                    "ìœ ê¸°ìš©ì œ/ë…ì„±ë¬¼ì§ˆ": [
                        "ë²¤ì  ", "í†¨ë£¨ì—”", "ìì¼ë Œ", "í¬ì‹¤ë Œ", "ì•„ì„¸í†¤", "ì‹œë„ˆ", "ì‹ ë„ˆ", "ë©”íƒ„ì˜¬", "ì•Œì½”ì˜¬", "ì—íƒ„ì˜¬",
                        "DMF", "TCE", "ìœ ê¸°ìš©ì œ", "ì„¸ì²™ì œ", "í˜ì¸íŠ¸", "ë„ì¥", "ê²½í™”ì œ", "ë°œì•”ì„±", "ìƒì‹ë…ì„±", "MSDS", "ë¬¼ì§ˆì•ˆì „ë³´ê±´ìë£Œ"
                    ],
                    "ì‚°/ì•Œì¹¼ë¦¬/ë¶€ì‹ì„±": [
                        "í™©ì‚°", "ì§ˆì‚°", "ì—¼ì‚°", "ë¶ˆì‚°", "ì¸ì‚°", "ìˆ˜ì‚°í™”ë‚˜íŠ¸ë¥¨", "ê°€ì„±ì†Œë‹¤", "ì•”ëª¨ë‹ˆì•„", "ë¶€ì‹", "í™”í•™í™”ìƒ",
                        "íìˆ˜", "ì¤‘í™”", "ì„¸ì•ˆì„¤ë¹„", "ìƒ¤ì›Œì„¤ë¹„", "PH"
                    ],
                    "ì§ˆì‹/ë°€íê°€ìŠ¤": [
                        "ë°€íê³µê°„", "ì‚°ì†Œê²°í•", "ì§ˆì‹", "í™©í™”ìˆ˜ì†Œ", "ì¼ì‚°í™”íƒ„ì†Œ", "ì´ì‚°í™”íƒ„ì†Œ", "ë©”íƒ„", "ì•„ë¥´ê³¤", "ì§ˆì†Œ",
                        "ë³µí•©ê°€ìŠ¤", "ë†ë„ì¸¡ì •", "í™˜ê¸°", "ì†¡ê¸°ë§ˆìŠ¤í¬", "ê³µê¸°í˜¸í¡ê¸°", "ë§¨í™€", "íƒ±í¬", "í”¼íŠ¸", "ì •í™”ì¡°"
                    ],
                    "ê¸ˆì†/ë¶„ì§„/í„": [
                        "ìš©ì ‘í„", "í„", "ë¶„ì§„", "ê°€ë£¨", "ë¨¼ì§€", "ì„ë©´", "ë‚©", "ìˆ˜ì€", "ì¹´ë“œë®´", "í¬ë¡¬", "ë§ê°„", "ë‹ˆì¼ˆ",
                        "ì œë ¨", "ì£¼ë¬¼", "ìƒŒë”©", "ê·¸ë¼ì¸ë”©", "ë°©ì§„", "êµ­ì†Œë°°ê¸°", "ì§‘ì§„ê¸°"
                    ],
                    "ê·¼ê³¨ê²©ê³„/ì¸ì²´ë¶€ë‹´": [
                        "ê·¼ê³¨ê²©ê³„", "ìš”í†µ", "ë””ìŠ¤í¬", "í—ˆë¦¬", "ì–´ê¹¨", "ì†ëª©", "ë¬´ë¦", "ê´€ì ˆ", "ê±´ì´ˆì—¼", "ìˆ˜ê·¼ê´€",
                        "ì¤‘ëŸ‰ë¬¼", "ë“¤ê¸°", "ë°˜ë³µì‘ì—…", "ë¶€ìì—°ìŠ¤ëŸ¬ìš´ìì„¸", "ìŠ¤íŠ¸ë ˆì¹­", "íœ´ì‹", "ì¸ë ¥ìš´ë°˜"
                    ],
                    "ì†ŒìŒ/ì²­ë ¥": [
                        "ì†ŒìŒ", "ë‚œì²­", "ì´ëª…", "ì²­ë ¥", "dB", "ë°ì‹œë²¨", "ê·€ë§ˆê°œ", "ê·€ë®ê°œ", "ì²­ë ¥ë³´ì¡´", "ì˜¤ë””ì˜¤", "ì‹œë„ëŸ¬ì›€"
                    ],
                    "ë‡Œì‹¬í˜ˆê´€/ì˜¨ì—´ì§ˆí™˜": [
                        "ë‡Œì‹¬í˜ˆê´€", "ë‡Œì¶œí˜ˆ", "ì‹¬ê·¼ê²½ìƒ‰", "í˜‘ì‹¬ì¦", "ê³ í˜ˆì••", "ë‹¹ë‡¨", "ê³ ì§€í˜ˆì¦", "í­ì—¼", "ì—´ì‚¬ë³‘",
                        "ì—´íƒˆì§„", "ì¼ì‚¬ë³‘", "íƒˆìˆ˜", "ê·¸ëŠ˜", "íœ´ì‹ì‹œê°„", "í˜¹í•œ", "ë™ìƒ", "ì €ì²´ì˜¨ì¦"
                    ],
                    "ìŠ¤íŠ¸ë ˆìŠ¤/ê²€ì§„": [
                        "ì§ë¬´ìŠ¤íŠ¸ë ˆìŠ¤", "ê°ì •ë…¸ë™", "ìš°ìš¸ì¦", "ë¶ˆë©´ì¦", "ê²€ì§„", "íŠ¹ìˆ˜ê²€ì§„", "ë°°ì¹˜ì „ê²€ì§„", "ì¼ë°˜ê²€ì§„", "ìœ ì†Œê²¬ì"
                    ],
                    "í¬ë ˆì¸/ì–‘ì¤‘ê¸°": [
                        "í¬ë ˆì¸", "í˜¸ì´ìŠ¤íŠ¸", "ì²œì¥í¬ë ˆì¸", "íƒ€ì›Œí¬ë ˆì¸", "ì´ë™ì‹í¬ë ˆì¸", "ì¹´ê³ ", "í•˜ì´ë“œë¡œ", "ì–‘ì¤‘", "ì¸ì–‘",
                        "ì¤„ê±¸ì´", "ìŠ¬ë§ë²¨íŠ¸", "ì™€ì´ì–´ë¡œí”„", "ì²´ì¸", "ìƒ¤í´", "í›…", "í•´ì§€ì¥ì¹˜", "ë³´ì¡°ë¡œí”„", "ì‹ í˜¸ìˆ˜"
                    ],
                    "ì§€ê²Œì°¨/ê±´ì„¤ê¸°ê³„": [
                        "ì§€ê²Œì°¨", "í¬í¬ë¦¬í”„íŠ¸", "ë°±í˜¸", "êµ´ì°©ê¸°", "í¬í¬ë ˆì¸", "ë¡œë”", "ë¶ˆë„ì €", "ë¤í”„", "ë ˆë¯¸ì½˜",
                        "íŒí”„ì¹´", "í•­íƒ€ê¸°", "ì²œê³µê¸°", "ë¡¤ëŸ¬", "í›„ì§„ê²½ë³´", "í˜‘ì°©", "ì¶©ëŒ", "ì‹ í˜¸ìˆ˜"
                    ],
                    "í”„ë ˆìŠ¤/ê³µì‘ê¸°ê³„": [
                        "í”„ë ˆìŠ¤", "ì „ë‹¨ê¸°", "ì ˆê³¡ê¸°", "ì„ ë°˜", "ë°€ë§", "ë“œë¦´", "ì—°ì‚­ê¸°", "ê·¸ë¼ì¸ë”", "ìˆ«ëŒ", "ì¹©",
                        "ë°©í˜¸ì¥ì¹˜", "ê´‘ì „ì", "ì–‘ìˆ˜ì¡°ì‘", "ë®ê°œ", "ìš¸", "ê°€ë™ì‹"
                    ],
                    "ì»¨ë² ì´ì–´/íšŒì „ì²´": [
                        "ì»¨ë² ì´ì–´", "ë²¨íŠ¸", "ë¡¤ëŸ¬", "ê¸°ì–´", "ì²´ì¸", "ìŠ¤í”„ë¡œí‚·", "íšŒì „ì¶•", "ë§ë¦¼", "ë¼ì„", "ë¹„ìƒì •ì§€", "í’€ì½”ë“œ"
                    ],
                    "ê°ì „/ì „ê¸°ì„¤ë¹„": [
                        "ê°ì „", "ëˆ„ì „", "ì ‘ì§€", "ì ˆì—°", "ì¶©ì „ë¶€", "ë¶„ì „ë°˜", "ë°°ì „ë°˜", "ì°¨ë‹¨ê¸°", "ì½˜ì„¼íŠ¸", "í”ŒëŸ¬ê·¸",
                        "ì¼€ì´ë¸”", "ì „ì„ ", "í™œì„ ", "ë³€ì••ê¸°", "ì´ë™ì „ì„ ", "ê²€ì „ê¸°", "ì „ê¸°ì‘ì—…"
                    ],
                    "í™”ì¬/í­ë°œ/í™”ê¸°": [
                        "í™”ì¬", "í­ë°œ", "ìš©ì ‘", "ìš©ë‹¨", "ë¶ˆí‹°", "ìŠ¤íŒŒí¬", "í™”ê¸°ì‘ì—…", "ì†Œí™”ê¸°", "ì†Œí™”ì „", "ì¸í™”ì„±",
                        "ê°€ì—°ì„±", "ë°œí™”", "ì—°ì†Œ", "í™”ì¬ê°ì‹œì", "ë¶ˆê½ƒ", "ë°©í™”í¬"
                    ],
                    "ë¹„ê³„/ì‘ì—…ë°œíŒ": [
                        "ë¹„ê³„", "ì‹œìŠ¤í…œë¹„ê³„", "ê°•ê´€ë¹„ê³„", "ë‹¬ë¹„ê³„", "ë§ë¹„ê³„", "ì‘ì—…ë°œíŒ", "í†µë¡œ", "ê°€ì„¤ê³„ë‹¨", "ìŠ¹ê°•ê³„ë‹¨",
                        "ì•ˆì „ë‚œê°„", "ë°œëë§‰ì´íŒ", "í´ë¨í”„", "ì—°ê²°í•€"
                    ],
                    "ì¶”ë½/ê°œêµ¬ë¶€": [
                        "ì¶”ë½", "ë–¨ì–´ì§", "ê°œêµ¬ë¶€", "ë‹¨ë¶€", "êµ¬ë©", "ë®ê°œ", "ì•ˆì „ëŒ€", "ìƒëª…ì¤„", "ê³ ì†Œì‘ì—…", "ì§€ë¶•",
                        "ì‚¬ë‹¤ë¦¬", "ìš°ë§ˆ", "ì•ˆì „ë°©ë§", "ì¶”ë½ë°©ì§€"
                    ],
                    "ê±°í‘¸ì§‘/ë™ë°”ë¦¬": [
                        "ê±°í‘¸ì§‘", "ë™ë°”ë¦¬", "ì‹œìŠ¤í…œë™ë°”ë¦¬", "íŒŒì´í”„ì„œí¬íŠ¸", "ë©ì—", "ì¥ì„ ", "ì½˜í¬ë¦¬íŠ¸", "íƒ€ì„¤", "ì–‘ìƒ",
                        "ë¶•ê´´", "ë¬´ë„ˆì§", "ì¢Œêµ´", "ë³€ìœ„"
                    ],
                    "êµ´ì°©/í† ëª©": [
                        "êµ´ì°©", "í„°íŒŒê¸°", "í™ë§‰ì´", "ê°€ì‹œì„¤", "í† ì‚¬", "ë²•ë©´", "ê¸°ìš¸ê¸°", "ë§¤ëª°", "ë¬´ë„ˆì§", "ì§€í•˜ë§¤ì„¤ë¬¼",
                        "ë°°ìˆ˜", "ì–‘ìˆ˜ê¸°", "ì˜¹ë²½", "ì„ì¶•"
                    ],
                    "ë³´í˜¸êµ¬(PPE)": [
                        "ì•ˆì „ëª¨", "ì•ˆì „í™”", "ë³´ì•ˆê²½", "ë³´ì•ˆë©´", "ì¥ê°‘", "ì¡°ë¼", "ê°ë°˜", "ë³´í˜¸ë³µ", "ë°©ì—´ë³µ", "ë§ˆìŠ¤í¬", "ì°©ìš©"
                    ],
                    "ì •ë¦¬ì •ëˆ/ì „ë„": [
                        "ì •ë¦¬ì •ëˆ", "ì²­ì†Œ", "ì²­ê²°", "ë°”ë‹¥", "ë¯¸ë„ëŸ¬ì›€", "ê±¸ë¦¼", "ë„˜ì–´ì§", "ì „ë„", "í†µë¡œí™•ë³´", "ìì¬ì ì¬",
                        "ì ì¹˜", "ë³´ê´€", "íê¸°ë¬¼", "ì¡°ëª…", "ì¡°ë„", "ì–´ë‘ì›€"
                    ],
                    "ì•ˆì „ì‹œì„¤/ì‹ í˜¸": [
                        "ë°©í˜¸ìš¸", "íœìŠ¤", "ë°”ë¦¬ì¼€ì´ë“œ", "ì ‘ê·¼ê¸ˆì§€", "ì¶œì…ê¸ˆì§€", "ê²½ê³ í‘œì§€", "ì•ˆì „í‘œì§€", "ìœ ë„", "ë¼ë°”ì½˜",
                        "ì‹ í˜¸", "ì‚¬ì´ë Œ", "ê²½ê´‘ë“±", "CCTV"
                    ],
                    "êµìœ¡/í–‰ì •/ê´€ë¦¬": [
                        "êµìœ¡", "TBM", "ì ê²€", "ìˆœì°°", "ì§€ì ", "ê°œì„ ", "ì¡°ì¹˜", "ìˆ˜ì¹™", "ì ˆì°¨ì„œ", "ì‘ì—…í—ˆê°€", "PTW",
                        "ê´€ë¦¬ê°ë…ì", "ì•ˆì „ê´€ë¦¬ì", "ìœ„í—˜ì„±í‰ê°€", "KRAS", "íšŒì˜"
                    ],
                    "ìœ ê¸°ìš©ì œ/ë„ì¥ì‘ì—…": [
                        "ë²¤ì  ", "í†¨ë£¨ì—”", "ìì¼ë Œ", "í¬ì‹¤ë Œ", "ì•„ì„¸í†¤", "ì‹œë„ˆ", "ì‹ ë„ˆ", "ë©”íƒ„ì˜¬", "ì•Œì½”ì˜¬", "ì—íƒ„ì˜¬",
                        "DMF", "TCE", "ì„¸ì²™ì œ", "í˜ì¸íŠ¸", "ë„ì¥", "ë¶“", "ë¡¤ëŸ¬", "ìŠ¤í”„ë ˆì´", "ê²½í™”ì œ", "í¬ì„ì œ", "ìœ ì¦ê¸°"
                    ],
                    "ì‚°/ì•Œì¹¼ë¦¬/ë¶€ì‹ì„±": [
                        "í™©ì‚°", "ì§ˆì‚°", "ì—¼ì‚°", "ë¶ˆì‚°", "ì¸ì‚°", "ìˆ˜ì‚°í™”ë‚˜íŠ¸ë¥¨", "ê°€ì„±ì†Œë‹¤", "ì•”ëª¨ë‹ˆì•„", "ë¶€ì‹", "í™”í•™í™”ìƒ",
                        "íìˆ˜", "ì¤‘í™”", "ì„¸ì•ˆì„¤ë¹„", "ê¸´ê¸‰ìƒ¤ì›Œ", "PH", "ë¦¬íŠ¸ë¨¸ìŠ¤", "ëˆ„ì¶œ"
                    ],
                    "ì§ˆì‹/ë°€í/ê°€ìŠ¤": [
                        "ë°€íê³µê°„", "ì‚°ì†Œê²°í•", "ì§ˆì‹", "í™©í™”ìˆ˜ì†Œ", "ì¼ì‚°í™”íƒ„ì†Œ", "ì´ì‚°í™”íƒ„ì†Œ", "ë©”íƒ„", "ì•„ë¥´ê³¤", "ì§ˆì†Œ",
                        "ë³µí•©ê°€ìŠ¤", "ë†ë„ì¸¡ì •", "í™˜ê¸°", "ì†¡ê¸°ë§ˆìŠ¤í¬", "ë§¨í™€", "íƒ±í¬", "í”¼íŠ¸", "ì •í™”ì¡°", "í¼ì§€"
                    ],
                    "ê¸ˆì†í„/ë¶„ì§„/í˜¸í¡ê¸°": [
                        "ìš©ì ‘í„", "í„", "ë¶„ì§„", "ê°€ë£¨", "ë¨¼ì§€", "ì„ë©´", "ë‚©", "ìˆ˜ì€", "ì¹´ë“œë®´", "í¬ë¡¬", "ë§ê°„", "ë‹ˆì¼ˆ",
                        "ì œë ¨", "ì£¼ë¬¼", "ìƒŒë”©", "ê·¸ë¼ì¸ë”©", "ë°©ì§„ë§ˆìŠ¤í¬", "ì§‘ì§„ê¸°", "íŠ¹ìˆ˜ê±´ê°•ì§„ë‹¨"
                    ],
                    "ìœ„í—˜ë¬¼/ìš©ê¸°ë³´ê´€": [
                        "ë“œëŸ¼í†µ", "ë§í†µ", "ìœ ë¥˜", "ê¸°ë¦„", "íœ˜ë°œìœ ", "ê²½ìœ ", "ë“±ìœ ", "MSDS", "ê²½ê³ í‘œì§€", "ì†Œë¶„ìš©ê¸°",
                        "ë³´ê´€ì°½ê³ ", "ë°©ìœ ì œ", "ëˆ„ìœ ", "í¡ì°©í¬"
                    ],
                    "ìˆ˜ê³µêµ¬/ë™ë ¥ê³µêµ¬": [
                        "ê·¸ë¼ì¸ë”", "ë“œë¦´", "ì ˆë‹¨ê¸°", "ì»¤í„°", "í•¨ë§ˆ", "ë§ì¹˜", "ë“œë¼ì´ë²„", "ë Œì¹˜", "ìŠ¤íŒ¨ë„ˆ", "í†±",
                        "ì „ë™ê³µêµ¬", "ì—ì–´ê±´", "íƒ€ì¹´", "ëª»", "ë‚ ì¹´ë¡œìš´", "ë² ì„", "ì°”ë¦¼"
                    ],
                    "í”„ë ˆìŠ¤/ì „ë‹¨/í˜‘ì°©": [
                        "í”„ë ˆìŠ¤", "ì „ë‹¨ê¸°", "ì ˆê³¡ê¸°", "ì„ ë°˜", "ë°€ë§", "CNC", "ê¸ˆí˜•", "í˜‘ì°©", "ë¼ì„", "ëˆŒë¦¼",
                        "ê´‘ì „ì", "ì–‘ìˆ˜ì¡°ì‘", "ë°©í˜¸ì¥ì¹˜", "ê²Œì´íŠ¸", "ì¸í„°ë¡"
                    ],
                    "íšŒì „ì²´/ì»¨ë² ì´ì–´": [
                        "ì»¨ë² ì´ì–´", "ë²¨íŠ¸", "ë¡¤ëŸ¬", "ê¸°ì–´", "ì²´ì¸", "ìŠ¤í”„ë¡œí‚·", "í’€ë¦¬", "íšŒì „ì¶•", "ë§ë¦¼", "ì¥ê°‘",
                        "ë¹„ìƒì •ì§€", "í’€ì½”ë“œ", "ë®ê°œ", "ìš¸"
                    ],
                    "ì••ë ¥ì„¤ë¹„/ë³´ì¼ëŸ¬": [
                        "ë³´ì¼ëŸ¬", "ì••ë ¥ìš©ê¸°", "ë°°ê´€", "ë°¸ë¸Œ", "í”Œëœì§€", "ê°œìŠ¤í‚·", "ì½¤í”„ë ˆìƒ¤", "ê³µê¸°ì••ì¶•ê¸°", "ì•ˆì „ë³€",
                        "íŒŒì—´íŒ", "ê²Œì´ì§€", "ì••ë ¥ê³„", "ìŠ¤íŒ€", "ì¦ê¸°", "ê³ ì••"
                    ],
                    "ë¡œë´‡/ìë™í™”ì„¤ë¹„": [
                        "ì‚°ì—…ìš©ë¡œë´‡", "ë¡œë´‡", "í‹°ì¹­", "êµì‹œ", "ë§¤ë‹ˆí“°ë ˆì´í„°", "AGV", "ìë™í™”", "ì„¼ì„œ", "íœìŠ¤", "ë°©í˜¸ìš¸", "ì˜¤ì‘ë™"
                    ],
                    "í¬ë ˆì¸/í˜¸ì´ìŠ¤íŠ¸": [
                        "í¬ë ˆì¸", "í˜¸ì´ìŠ¤íŠ¸", "ì²œì¥í¬ë ˆì¸", "ì–‘ì¤‘", "ì¸ì–‘", "í›…", "í•´ì§€ì¥ì¹˜", "ê³¼ë¶€í•˜ë°©ì§€", "ê¶Œê³¼ë°©ì§€",
                        "ë¶ëŒ€", "ì•„ì›ƒíŠ¸ë¦¬ê±°", "ì „ë„"
                    ],
                    "ì¤„ê±¸ì´/ë¦¬ê¹…": [
                        "ì¤„ê±¸ì´", "ìŠ¬ë§ë²¨íŠ¸", "ì™€ì´ì–´ë¡œí”„", "ìƒ¤í´", "ì²´ì¸ë¸”ëŸ­", "ë ˆë²„ë¸”ëŸ­", "ë§¤ë“­", "íŒŒë‹¨", "ì†Œì„ ", "í‚¹í¬", "ë¶€ì‹"
                    ],
                    "ì§€ê²Œì°¨/ìš´ë°˜ì°¨ëŸ‰": [
                        "ì§€ê²Œì°¨", "í¬í¬", "ë°±ë ˆìŠ¤íŠ¸", "í—¤ë“œê°€ë“œ", "ì „ì¡°ë“±", "í›„ë¯¸ë“±", "í›„ì§„ê²½ë³´ê¸°", "ì•ˆì „ë²¨íŠ¸", "ê³¼ì†",
                        "ì¶©ëŒ", "ìš´ì „ì›", "ë©´í—ˆ", "í‚¤ë°•ìŠ¤"
                    ],
                    "ê±´ì„¤ê¸°ê³„/ì¤‘ì¥ë¹„": [
                        "êµ´ì°©ê¸°", "í¬í¬ë ˆì¸", "ë°±í˜¸", "ë¡œë”", "ë¶ˆë„ì €", "ë¤í”„íŠ¸ëŸ­", "ë ˆë¯¸ì½˜", "íŒí”„ì¹´", "í•­íƒ€ê¸°", "ì²œê³µê¸°",
                        "ì‚¬ê°ì§€ëŒ€", "ìœ ë„ì", "ì‹ í˜¸ìˆ˜"
                    ],
                    "ê°ì „/ì ‘ì§€/ì ˆì—°": [
                        "ê°ì „", "ëˆ„ì „", "ì ‘ì§€", "ì ˆì—°", "ì¶©ì „ë¶€", "ë…¸ì¶œ", "í”¼ë³µ", "ì†ìƒ", "ë¬¼ê¸°", "ìŠµê¸°", "ì „ê¸°ì‘ì—…", "ì •ì „"
                    ],
                    "ë°°ì „ë°˜/ì „ì„¤ì„¤ë¹„": [
                        "ë¶„ì „ë°˜", "ë°°ì „ë°˜", "ì°¨ë‹¨ê¸°", "ê°œíê¸°", "ì½˜ì„¼íŠ¸", "í”ŒëŸ¬ê·¸", "ë©€í‹°íƒ­", "ë¼ì§€ì½”", "ì „ì„ ", "ì¼€ì´ë¸”",
                        "ê°€ê³µì „ì„ ", "ì„ì‹œì „ë ¥", "ë³€ì••ê¸°"
                    ],
                    "ì •ì „ê¸°/ë°©í­": [
                        "ì •ì „ê¸°", "ì œì „", "ë°©í­", "ë‚´ì••ë°©í­", "ë³¸ì§ˆì•ˆì „", "ìŠ¤íŒŒí¬", "ì í™”ì›", "Bonding", "ì–´ìŠ¤"
                    ],
                    "ë¹„ê³„/ë°œíŒ/ê°€ì„¤": [
                        "ë¹„ê³„", "ì‹œìŠ¤í…œë¹„ê³„", "ê°•ê´€ë¹„ê³„", "ë¹„ê³„ë‹¤ë¦¬", "ì‘ì—…ë°œíŒ", "í†µë¡œ", "ê°€ì„¤ê³„ë‹¨", "í´ë¨í”„", "ì—°ê²°í•€",
                        "ë²½ì´ìŒ", "ì„¤ì¹˜", "í•´ì²´"
                    ],
                    "ì¶”ë½/ê³ ì†Œì‘ì—…": [
                        "ì¶”ë½", "ë–¨ì–´ì§", "ì•ˆì „ëŒ€", "ê·¸ë„¤ì‹", "ìƒëª…ì¤„", "ê³ ë¦¬", "ì§€ë¶•", "ìŠ¬ë ˆì´íŠ¸", "ì¬ë¼ì´íŠ¸", "ê°œêµ¬ë¶€",
                        "ë‹¨ë¶€", "ë‚œê°„", "ë°©ë§"
                    ],
                    "ì‚¬ë‹¤ë¦¬/ì´ë™ì‹ì‘ì—…ëŒ€": [
                        "ì‚¬ë‹¤ë¦¬", "Aí˜•ì‚¬ë‹¤ë¦¬", "ì¼ìì‚¬ë‹¤ë¦¬", "ìš°ë§ˆ", "ë§ë¹„ê³„", "ê³ ì†Œì‘ì—…ëŒ€", "ë Œíƒˆ", "ìŠ¤ì¹´ì´", "ì „ë„", "ì•„ìš°íŠ¸ë¦¬ê±°"
                    ],
                    "ê±°í‘¸ì§‘/ë™ë°”ë¦¬/ì½˜í¬ë¦¬íŠ¸": [
                        "ê±°í‘¸ì§‘", "ë™ë°”ë¦¬", "ì‹œìŠ¤í…œë™ë°”ë¦¬", "ì„œí¬íŠ¸", "ë©ì—", "ì¥ì„ ", "ìœ ë¡œí¼", "ì½˜í¬ë¦¬íŠ¸", "íƒ€ì„¤", "ì–‘ìƒ",
                        "ë¶•ê´´", "í•˜ì¤‘"
                    ],
                    "í† ëª©/êµ´ì°©/í™ë§‰ì´": [
                        "êµ´ì°©", "í„°íŒŒê¸°", "í™ë§‰ì´", "ê°€ì‹œì„¤", "í† ì‚¬", "ë²•ë©´", "ì‚¬ë©´", "ë¬´ë„ˆì§", "ë§¤ëª°", "ì§€í•˜ìˆ˜", "ë°°ìˆ˜", "ì˜¹ë²½"
                    ],
                    "í™”ì¬/ì†Œí™”ì„¤ë¹„": [
                        "í™”ì¬", "ë¶ˆ", "ì—°ê¸°", "ì†Œí™”ê¸°", "ì†Œí™”ì „", "ìŠ¤í”„ë§í´ëŸ¬", "ê°ì§€ê¸°", "ê²½ë³´ê¸°", "ë°œì‹ ê¸°", "ë¹„ìƒë²¨",
                        "ë°©í™”ë¬¸", "ì…”í„°", "êµ¬íš"
                    ],
                    "ìš©ì ‘/í™”ê¸°ì‘ì—…": [
                        "ìš©ì ‘", "ìš©ë‹¨", "ì ˆë‹¨", "ì‚°ì†Œ", "LPG", "ì•„ì„¸í‹¸ë Œ", "ê°€ìŠ¤í†µ", "í† ì¹˜", "ë¶ˆí‹°", "ë¶ˆê½ƒ", "ë¹„ì‚°",
                        "ë°©í™”í¬", "í™”ì¬ê°ì‹œì"
                    ],
                    "ë¹„ìƒëŒ€ì‘/ëŒ€í”¼": [
                        "ë¹„ìƒêµ¬", "ëŒ€í”¼", "íƒˆì¶œ", "í”¼ë‚œ", "ìœ ë„ë“±", "í†µë¡œ", "ì¥ì• ë¬¼", "ì ì¹˜", "í›ˆë ¨", "ì‘ê¸‰ì²˜ì¹˜",
                        "AED", "êµ¬ê¸‰í•¨"
                    ],
                    "ê·¼ê³¨ê²©ê³„/ì¸ì²´": [
                        "ê·¼ê³¨ê²©ê³„", "ìš”í†µ", "í—ˆë¦¬", "ì–´ê¹¨", "ì†ëª©", "ë¬´ë¦", "í†µì¦", "ì¤‘ëŸ‰ë¬¼", "ë“¤ê¸°", "ë°˜ë³µ", "ìì„¸", "ìŠ¤íŠ¸ë ˆì¹­"
                    ],
                    "ì†ŒìŒ/ì§„ë™/ì²­ë ¥": [
                        "ì†ŒìŒ", "ì‹œë„ëŸ¬ì›€", "ë‚œì²­", "ì´ëª…", "ê·€ë§ˆê°œ", "ê·€ë®ê°œ", "ì§„ë™", "ì°©ì•”ê¸°", "ë–¨ë¦¼", "ë°±ëë³‘"
                    ],
                    "ê³ ì˜¨/ì €ì˜¨/ë‚ ì”¨": [
                        "í­ì—¼", "ë”ìœ„", "ì—´ì‚¬ë³‘", "ì¼ì‚¬ë³‘", "íƒˆì§„", "íœ´ì‹", "ë¬¼", "ê·¸ëŠ˜", "í˜¹í•œ", "ì¶”ìœ„", "ë™ìƒ",
                        "ì €ì²´ì˜¨", "ê°•í’", "íƒœí’", "ë¹„", "ëˆˆ"
                    ],
                    "ìƒë¬¼í•™/ê°ì—¼/ìœ„ìƒ": [
                        "ì‹ì¤‘ë…", "ê°ì—¼", "ë°”ì´ëŸ¬ìŠ¤", "ì„¸ê· ", "ê³°íŒ¡ì´", "ë²Œë ˆ", "í•´ì¶©", "ì¥", "ë™ë¬¼", "ì£¼ì‚¬ê¸°",
                        "í˜ˆì•¡", "ìœ„ìƒ", "ì‹ë‹¹", "í™”ì¥ì‹¤"
                    ],
                    "ë°©ì‚¬ì„ /ë ˆì´ì €/ë¹›": [
                        "ë°©ì‚¬ì„ ", "X-ray", "RT", "ë¹„íŒŒê´´", "ë™ìœ„ì›ì†Œ", "ì„ ëŸ‰ê³„", "í”¼í­", "ë ˆì´ì €", "ê´‘ì„ ", "ìì™¸ì„ ", "ìš©ì ‘ë©´"
                    ],
                    "ì¡°ëª…/ì‘ì—…í™˜ê²½": [
                        "ì¡°ëª…", "ì¡°ë„", "ì–´ë‘ì›€", "ê¹œë¹¡ì„", "ì „êµ¬", "ë¨í”„", "ì•¼ê°„ì‘ì—…", "ì‹œì•¼", "í™•ë³´", "ëˆˆë¶€ì‹¬"
                    ],
                    "ì •ë¦¬ì •ëˆ/ì „ë„": [
                        "ì •ë¦¬ì •ëˆ", "ì²­ì†Œ", "ë°”ë‹¥", "ë¬¼ê¸°", "ì˜¤ì¼", "ë¯¸ë„ëŸ¬ì›€", "ê±¸ë¦¼", "ë„˜ì–´ì§", "ì „ë„", "ìì¬", "ì ì¬", "íê¸°ë¬¼"
                    ],
                    "ë³´í˜¸êµ¬(PPE)": [
                        "ì•ˆì „ëª¨", "í„±ëˆ", "ì•ˆì „í™”", "ê¹”ì°½", "ë³´ì•ˆê²½", "ë³´ì•ˆë©´", "ì¥ê°‘", "ì•ˆì „ì¡°ë¼", "ê°ë°˜", "ë³´í˜¸ë³µ", "ì°©ìš©"
                    ],
                    "ì•ˆì „ì‹œì„¤/í‘œì§€": [
                        "ì•ˆì „í‘œì§€", "ê²½ê³ ", "ê¸ˆì§€", "ì§€ì‹œ", "ì•ˆë‚´", "í˜„ìˆ˜ë§‰", "í‘œì§€íŒ", "ë¼ë°”ì½˜", "ë°”ë¦¬ì¼€ì´ë“œ", "PEë“œëŸ¼", "êµ¬íš"
                    ],
                    "ê´€ë¦¬/êµìœ¡/ì ˆì°¨": [
                        "ê´€ë¦¬ê°ë…ì", "ì•ˆì „ê´€ë¦¬ì", "ì‘ì—…ì§€íœ˜ì", "êµìœ¡", "TBM", "ì ê²€", "ìˆœì°°", "í—ˆê°€ì„œ", "PTW",
                        "ìœ„í—˜ì„±í‰ê°€", "íšŒì˜", "ì§€ì "
                    ],
                    "ë™ë ¥ì „ë‹¬/ì¶•/íšŒì „": ["íšŒì „ì¶•", "ì»¤í”Œë§", "í”Œëœì§€", "í’€ë¦¬", "ê¸°ì–´", "ìŠ¤í”„ë¡œí‚·", "ì²´ì¸", "ì¶•ì»¤í”Œë§", "íšŒì „ë¶€", "ë…¸ì¶œ", "ë®ê°œë¯¸ë¹„"],
                    "ë¼ì„/ë§ë¦¼/ì¸ì ‘": ["ì»¨ë² ì´ì–´", "ë¡¤ëŸ¬", "ë²¨íŠ¸", "ë¼ì„", "ë§ë¦¼", "í˜‘ì°©", "ë¹„ìƒì •ì§€", "í’€ì½”ë“œ", "ì¸í„°ë¡", "ê°€ë“œ"],
                    "í”„ë ˆìŠ¤/ê¸ˆí˜•/ì••ì°©": ["í”„ë ˆìŠ¤", "ê¸ˆí˜•", "ì „ë‹¨ê¸°", "ì ˆê³¡ê¸°", "ë‹¤ì´", "í€ì¹˜", "ìŠ¬ë¼ì´ë“œ", "ì–‘ìˆ˜ì¡°ì‘", "ê´‘ì „ì"],
                    "ìˆ˜ê³µêµ¬/ë² ì„/ì°”ë¦¼": ["ì»¤í„°", "ì¹¼", "ë“œë¼ì´ë²„", "ë§ì¹˜", "í•¨ë§ˆ", "ìŠ¤íŒ¨ë„ˆ", "ë Œì¹˜", "ë² ì„", "ì°”ë¦¼", "ë‚ ì¹´ë¡œìš´", "íŒŒí¸"],
                    "ë™ë ¥ê³µêµ¬/ê·¸ë¼ì¸ë”": ["ê·¸ë¼ì¸ë”", "ìˆ«ëŒ", "ë®ê°œ", "ì ˆë‹¨ê¸°", "ë“œë¦´", "ì„íŒ©", "í†±", "ì›í˜•í†±", "ë¶ˆê½ƒë°©ì§€"],
                    "ë‚˜ì‚¬/ë³¼íŠ¸/ì²´ê²°": ["ë³¼íŠ¸", "ë„ˆíŠ¸", "ì™€ì…”", "í•€", "ì²´ê²°", "í’€ë¦¼", "ë§ˆëª¨", "ë¶€ì‹", "ì´íƒˆ", "íƒˆë½"],
                    "í¬ë ˆì¸/ì–‘ì¤‘ì„¤ë¹„": ["í¬ë ˆì¸", "í˜¸ì´ìŠ¤íŠ¸", "ì²œì¥í¬ë ˆì¸", "íƒ€ì›Œí¬ë ˆì¸", "ì–‘ì¤‘", "ì¸ì–‘", "ê³¼ë¶€í•˜", "ê¶Œê³¼"],
                    "ì¤„ê±¸ì´/ìŠ¬ë§/ìƒ¤í´": ["ì™€ì´ì–´ë¡œí”„", "ìŠ¬ë§ë²¨íŠ¸", "ìƒ¤í´", "í›…", "í•´ì§€ì¥ì¹˜", "ê¼¬ì„", "ë‹¨ì„ ", "ë¶€ì‹", "ë§¤ë“­"],
                    "ì§€ê²Œì°¨/í™”ë¬¼ì°¨": ["ì§€ê²Œì°¨", "í¬í¬", "ë°±ë ˆìŠ¤íŠ¸", "í›„ì§„ê²½ë³´", "ì•ˆì „ë²¨íŠ¸", "ê³¼ì†", "ì¶©ëŒ", "ìš´ë°˜", "ìƒí•˜ì°¨"],
                    "ê±´ì„¤ì¤‘ì¥ë¹„/í† ëª©": ["êµ´ì°©ê¸°", "ë¤í”„", "ë¡œë”", "íŒí”„ì¹´", "í•­íƒ€ê¸°", "ì‚¬ê°ì§€ëŒ€", "ìœ ë„ì", "ì‹ í˜¸ìˆ˜", "í˜‘ì°©"],
                    "ê³ ì†Œì‘ì—…ëŒ€/ë Œíƒˆ": ["ê³ ì†Œì‘ì—…ëŒ€", "ë Œíƒˆ", "ìŠ¤ì¹´ì´", "ë¦¬í”„íŠ¸", "ì•„ìš°íŠ¸ë¦¬ê±°", "ê³¼ìƒìŠ¹", "ì¶”ë½"],
                    "ì¶©ì „ë¶€/ë…¸ì¶œ/ì „ì„ ": ["ì¶©ì „ë¶€", "í”¼ë³µ", "ì†ìƒ", "ì „ì„ ", "ì¼€ì´ë¸”", "ê°€ê³µì „ì„ ", "ì„ì‹œì „ì„ ", "ë¬¼ê¸°", "ì ˆì—°"],
                    "ì°¨ë‹¨ê¸°/ë¶„ì „ë°˜": ["ë¶„ì „ë°˜", "ë°°ì „ë°˜", "ì°¨ë‹¨ê¸°", "ELB", "MCCB", "ê°œíê¸°", "ì½˜ì„¼íŠ¸", "í”ŒëŸ¬ê·¸", "ê³¼ë¶€í•˜"],
                    "ì ‘ì§€/ëˆ„ì „/ì •ì „ê¸°": ["ì ‘ì§€", "ëˆ„ì „", "ì „ìœ„", "ë³¸ë”©", "ì •ì „ê¸°", "ì œì „", "ê°ì „", "ì ˆì—°ì¥ê°‘", "ê²€ì „ê¸°"],
                    "ë°©í­/íŠ¹ìˆ˜ì „ê¸°": ["ë°©í­", "ë‚´ì••", "ë³¸ì§ˆì•ˆì „", "ê°€ìŠ¤ëˆ„ì¶œ", "ì í™”ì›", "ì „ê¸°ë°©ì „", "ìŠ¤íŒŒí¬"],
                    "ìš©ì ‘/ìš©ë‹¨/ë¶ˆê½ƒ": ["ìš©ì ‘", "ìš©ë‹¨", "í† ì¹˜", "ì‚°ì†Œ", "ì•„ì„¸í‹¸ë Œ", "LPG", "ê°€ìŠ¤í†µ", "ë¶ˆê½ƒ", "ë¹„ì‚°", "ë°©í™”í¬"],
                    "ì†Œí™”/ê²½ë³´ì„¤ë¹„": ["ì†Œí™”ê¸°", "ì†Œí™”ì „", "ìŠ¤í”„ë§í´ëŸ¬", "ê°ì§€ê¸°", "ê²½ë³´ê¸°", "ë°œì‹ ê¸°", "ë¹„ìƒë²¨", "ìœ ë„ë“±"],
                    "ì¸í™”ì„±/í­ë°œë¬¼": ["ì¸í™”ì„±", "ê°€ì—°ì„±", "í­ë°œ", "ë°œí™”", "ìì—°ë°œí™”", "ìœ ì¦ê¸°", "ìœ„í—˜ë¬¼ë³´ê´€", "ë°©ìœ ì œ"],
                    "ë¹„ìƒëŒ€í”¼/í†µë¡œ": ["ë¹„ìƒêµ¬", "í”¼ë‚œ", "íƒˆì¶œ", "í”¼ë‚œê³„ë‹¨", "ì¥ì• ë¬¼", "íì‡„", "ëŒ€í”¼ì†Œ", "í›ˆë ¨"],
                    "ì¶”ë½/ë‹¨ë¶€/ê°œêµ¬ë¶€": ["ì¶”ë½", "ë–¨ì–´ì§", "ê°œêµ¬ë¶€", "ë‹¨ë¶€", "êµ¬ë©", "ë®ê°œ", "ì•ˆì „ë‚œê°„", "ë°©ë§", "ìƒëª…ì¤„"],
                    "ë¹„ê³„/ë°œíŒ/ê°€ì„¤": ["ë¹„ê³„", "ì‹œìŠ¤í…œë¹„ê³„", "ì‘ì—…ë°œíŒ", "ê°€ì„¤í†µë¡œ", "í´ë¨í”„", "ë²½ì´ìŒ", "í•´ì²´", "ì„¤ì¹˜"],
                    "ì‚¬ë‹¤ë¦¬/ë§ë¹„ê³„": ["ì‚¬ë‹¤ë¦¬", "ìš°ë§ˆ", "ë§ë¹„ê³„", "ì´ë™ì‹ì‚¬ë‹¤ë¦¬", "2ì¸1ì¡°", "ì „ë„", "ë¯¸ë„ëŸ¼ë°©ì§€"],
                    "ë¶•ê´´/í™ë§‰ì´/ì§€ë°˜": ["ë¶•ê´´", "ë¬´ë„ˆì§", "ë™ë°”ë¦¬", "í™ë§‰ì´", "ì‚¬ë©´", "í† ì‚¬", "ì¹¨í•˜", "ê· ì—´", "ì „ì¡°"],
                    "ë°€í/ì§ˆì‹/ì‚°ì†Œ": ["ë°€íê³µê°„", "ì‚°ì†Œê²°í•", "í™©í™”ìˆ˜ì†Œ", "ì¼ì‚°í™”íƒ„ì†Œ", "ë†ë„ì¸¡ì •", "í™˜ê¸°", "ì†¡ê¸°ë§ˆìŠ¤í¬", "íƒ±í¬"],
                    "ìœ ê¸°ìš©ì œ/í™”í•™ìƒ": ["ë²¤ì  ", "í†¨ë£¨ì—”", "ì‹œë„ˆ", "ì„¸ì²™ì œ", "ë„ì¥", "MSDS", "ì†Œë¶„ìš©ê¸°", "í™”í•™í™”ìƒ", "ìƒ¤ì›Œ"],
                    "ë¶„ì§„/ì„ë©´/í„": ["ë¶„ì§„", "ê°€ë£¨", "ì„ë©´", "ìš©ì ‘í„", "ë¨¼ì§€", "ì§‘ì§„ê¸°", "ë°©ì§„ë§ˆìŠ¤í¬", "í˜¸í¡ê¸°"],
                    "ê·¼ê³¨ê²©ê³„/ìì„¸": ["ìš”í†µ", "í—ˆë¦¬", "ì–´ê¹¨", "ì†ëª©", "ë¶€ìì—°ìŠ¤ëŸ¬ìš´", "ì¤‘ëŸ‰ë¬¼", "ë°˜ë³µ", "ìŠ¤íŠ¸ë ˆì¹­"],
                    "ì†ŒìŒ/ì§„ë™/ì²­ë ¥": ["ì†ŒìŒ", "ë‚œì²­", "ì´ëª…", "ê·€ë§ˆê°œ", "ì§„ë™", "ë°±ëë³‘", "ì†ŒìŒì¸¡ì •"],
                    "ì˜¨ì—´/ê¸°ìƒ/ë‚ ì”¨": ["í­ì—¼", "ì—´ì‚¬ë³‘", "íƒˆì§„", "ê·¸ëŠ˜", "í˜¹í•œ", "ë™ìƒ", "ê°•í’", "íƒœí’", "ë¯¸ì„¸ë¨¼ì§€"],
                    "ì •ë¦¬/ë°”ë‹¥/ì „ë„": ["ì •ë¦¬ì •ëˆ", "ë¯¸ë„ëŸ¬ì›€", "ê±¸ë¦¼", "ë„˜ì–´ì§", "ì „ë„", "ì˜¤ì¼", "ë¬¼ê¸°", "íê¸°ë¬¼"],
                    "ì¡°ëª…/ì•¼ê°„/ì‹œì•¼": ["ì¡°ë„", "ì–´ë‘ì›€", "ì¡°ëª…", "ì•¼ê°„", "ì‹œì•¼ë¯¸í™•ë³´", "ê¹œë¹¡ì„", "ì „êµ¬"],
                    "ì•ˆì „ëª¨/ë³´í˜¸êµ¬": ["ì•ˆì „ëª¨", "í„±ëˆ", "ì•ˆì „í™”", "ë³´ì•ˆê²½", "ì•ˆì „ëŒ€", "ì¥ê°‘", "ì°©ìš©", "ì†ìƒ", "ë…¸í›„"],
                    "ê´€ë¦¬/êµìœ¡/ì„œë¥˜": ["ì•ˆì „êµìœ¡", "TBM", "ì ê²€", "ìˆ˜ì¹™", "ì ˆì°¨", "ìœ„í—˜ì„±í‰ê°€", "í—ˆê°€ì„œ", "íšŒì˜", "ì§€íœ˜"],
                    "í‘œì§€/êµ¬íš/ì°¨ë‹¨": ["ì•ˆì „í‘œì§€", "ë°”ë¦¬ì¼€ì´ë“œ", "ë¼ë°”ì½˜", "êµ¬íš", "ì¶œì…ê¸ˆì§€", "ê²½ê³ ", "ê¸ˆì§€"]
                };

                const categoryNames = Object.keys(Categories);
                const categoryValues = Object.values(Categories).flat();
                const externalTerms = externalJson.map(item => item.ìš©ì–´ ? item.ìš©ì–´.replace(/,/g, '').trim() : item);
                const allTerms = [...new Set([...categoryNames, ...categoryValues, ...externalTerms])];

                // 3. AI ì„ë² ë”© ì¶”ì¶œ (ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”)
                const textOnly = flattened.map(f => f.text);

                // [ìˆ˜ì • í•µì‹¬] ì—¬ê¸°ì„œ ì—ëŸ¬ê°€ ë‚˜ë©´ catch ë¸”ë¡ìœ¼ë¡œ ì´ë™í•˜ì—¬ ë©ˆì¶¤
                const embeddings = await window.getEmbeddingsFromGoogle(textOnly);

                // [ì•ˆì „ì¥ì¹˜] ë§Œì•½ ì„ë² ë”© ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ ê°œìˆ˜ê°€ ë§ì§€ ì•Šìœ¼ë©´ ì¤‘ë‹¨
                if (!embeddings || embeddings.length !== textOnly.length) {
                    throw new Error("AI ë°ì´í„° ìˆ˜ì‹  ì‹¤íŒ¨ (ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ)");
                }

                // 4. ê·¸ë£¹í™” ë¡œì§ (H-ACD)
                const groups = [];
                const visited = new Array(flattened.length).fill(false);
                const THRESHOLD = 0.82;

                for (let i = 0; i < flattened.length; i++) {
                    if (visited[i]) continue;

                    const group = { representative: flattened[i], members: [] };
                    visited[i] = true;

                    for (let j = i + 1; j < flattened.length; j++) {
                        if (visited[j]) continue;

                        // embeddings[i]ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í•œë²ˆ ë” í™•ì¸
                        if (!embeddings[i] || !embeddings[j]) continue;

                        const score = calculateHACDScore(
                            flattened[i].text, embeddings[i],
                            flattened[j].text, embeddings[j],
                            Categories, allTerms, STEP_WEIGHTS
                        );

                        if (score >= THRESHOLD) {
                            group.members.push(flattened[j]);
                            visited[j] = true;
                        }
                    }
                    groups.push(group);
                }
                renderGroupEditor(groups);

            } catch (e) {
                console.error(e);
                // [ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ] í™”ë©´ì— ë¹¨ê°„ ê¸€ì”¨ë¡œ ì›ì¸ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                resultBody.innerHTML = `<div style="color:red; text-align:center; padding:20px;">
                    <b>ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ</b><br>
                    AI ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                    <small>${e.message}</small>
                </div>`;
            }
        }

        function calculateHACDScore(s1, v1, s2, v2, Categories, allTerms, STEP_WEIGHTS) {
            // [H] ìƒíƒœ íŒì • (Shield ë¡œì§)
            const hScore = (() => {
                const negWords = ['ì•ˆ', 'ë¯¸', 'ë¶ˆ', 'ë¶€', 'ë¹„', 'ë¬´', 'ì•Š', 'ëª»', 'ì œì™¸', 'ê²°ì—¬', 'ë¶€ì¡±', 'ë¶ˆëŸ‰', 'ë¯¸í¡', 'ì—†', 'ê±°ê¾¸ë¡œ', 'ë°©ì¹˜'];
                const shield = (text) => {
                    let temp = text;
                    // ê¸´ ë‹¨ì–´ë¶€í„° ì¹˜í™˜í•˜ì—¬ ì‰´ë“œ ì²˜ë¦¬ (ë‹¨ì–´ ì‚¬ì „ì´ ìˆëŠ” ê²½ìš°)
                    allTerms.sort((a, b) => b.length - a.length).forEach(word => {
                        temp = temp.split(word).join("###");
                    });
                    return temp;
                };
                // ë‹¨ì–´ ì‚¬ì „ì´ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ ì‰´ë“œ ì²˜ë¦¬ë¼ë„ ìˆ˜í–‰
                const simpleShield = (text) => text.replace(/[ê°€-í£]{2,}/g, "###");

                const p1 = allTerms.length > 0 ? shield(s1) : simpleShield(s1);
                const p2 = allTerms.length > 0 ? shield(s2) : simpleShield(s2);

                const h1 = negWords.some(w => p1.includes(w));
                const h2 = negWords.some(w => p2.includes(w));
                return (h1 !== h2) ? 0.0 : 1.0;
            })();

            // H ì ìˆ˜ê°€ 0ì´ë©´ ì¦‰ì‹œ 0ì  ë°˜í™˜ (ìƒë°˜ëœ ìƒíƒœ)
            if (hScore === 0) return 0.0;

            // [C] ì¹´í…Œê³ ë¦¬ ë§¤ì¹­
            const cScore = (() => {
                // 1. ë‹¨ì–´ ì™„ì „ ì¼ì¹˜
                for (const term of allTerms) {
                    if (s1.includes(term) && s2.includes(term)) return 1.0;
                }
                // 2. ì¹´í…Œê³ ë¦¬/í…Œë§ˆ ì¼ì¹˜
                for (const [groupName, terms] of Object.entries(Categories)) {
                    const groupKey = groupName.split('/')[0];
                    const inS1 = terms.some(t => s1.includes(t)) || s1.includes(groupKey);
                    const inS2 = terms.some(t => s2.includes(t)) || s2.includes(groupKey);
                    if (inS1 && inS2) return 0.8;
                }
                // 3. ì¼ë°˜ ì•ˆì „ ìš©ì–´ í¬í•¨ ì—¬ë¶€
                const hasS1 = allTerms.some(t => s1.includes(t));
                const hasS2 = allTerms.some(t => s2.includes(t));
                return (hasS1 && hasS2) ? 0.4 : 0.2;
            })();

            // [A] ë¬¸ë§¥ ìœ ì‚¬ë„ (ì„ë² ë”© ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
            const aScore = ((vec1, vec2) => {
                let dot = 0, n1 = 0, n2 = 0;
                for (let i = 0; i < vec1.length; i++) {
                    dot += vec1[i] * vec2[i];
                    n1 += vec1[i] * vec1[i];
                    n2 += vec2[i] * vec2[i];
                }
                return dot / (Math.sqrt(n1) * Math.sqrt(n2));
            })(v1, v2);

            // [D] ì–´ë¯¸ íŒ¨í„´ ì¼ì¹˜
            const dScore = (s1.slice(-2) === s2.slice(-2)) ? 1.0 : 0.6;

            // ê°€ì¤‘ì¹˜ ì ìš© í•©ì‚°
            // ìˆœì„œ: C(45%) + A(35%) + D(20%)
            const totalScore = (cScore * STEP_WEIGHTS[0]) + (aScore * STEP_WEIGHTS[1]) + (dScore * STEP_WEIGHTS[2]);

            // H ì ìˆ˜(1.0 or 0.0) ê³±í•˜ê¸°
            return totalScore * hScore;
        }

        function renderGroupEditor(groups) {
            const body = document.getElementById('analysisResultBody');
            body.innerHTML = '';
            document.getElementById('saveReGroupBtn').style.display = 'inline-block';

            groups.forEach((g, idx) => {
                const isGroup = g.members.length > 0;
                let items = `<li id="it-${idx}-rep" class="draggable-item is-rep" draggable="true" ondragstart="drag(event)" ondblclick="setRep(this)" data-text="${g.representative.text}" data-name="${g.representative.name}" style="padding:8px;">
                    <span class="badge" style="color:#10b981; font-weight:bold;">[ê¸°ì¤€]</span> ${g.representative.text}</li>`;
                g.members.forEach((m, midx) => {
                    items += `<li id="it-${idx}-${midx}" class="draggable-item" draggable="true" ondragstart="drag(event)" ondblclick="setRep(this)" data-text="${m.text}" data-name="${m.name}" style="padding:8px;">${m.text}</li>`;
                });

                body.insertAdjacentHTML('beforeend', `
                    <div class="group-box ${isGroup ? 'common-group' : 'unique-group'}">
                        <div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">
                            <span class="group-tag ${isGroup ? 'tag-common' : 'tag-unique'}">${isGroup ? 'ê·¸ë£¹' : 'ê°œë³„'}</span>
                            <strong class="kw">${g.representative.text}</strong>
                        </div>
                        <ul ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" style="list-style:none; padding:0; min-height:40px;">${items}</ul>
                    </div>`);
            });
        }

        function saveReGroupedData() {
            const boxes = document.querySelectorAll('.group-box');
            const total = Array.from(boxes).reduce((a, b) => a + b.querySelectorAll('li').length, 0);

            savedAnalysisReport = Array.from(boxes).map(box => {
                const items = Array.from(box.querySelectorAll('li'));
                return {
                    type: box.querySelector('.group-tag').innerText,
                    keyword: box.querySelector('.kw').innerText,
                    content: items.map(li => `- ${li.getAttribute('data-text')}`).join('<br>'),
                    rawItems: items.map(li => ({
                        text: li.getAttribute('data-text'),
                        name: li.getAttribute('data-name')
                    })),
                    ratio: ((items.length / total) * 100).toFixed(1) + '%'
                };
            });

            // [í•µì‹¬ ìˆ˜ì •] ë¦¬í¬íŠ¸ ë°ì´í„°ì™€ ì´ë¦„ ì •ë³´ë¥¼ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ë¬¶ìŒ
            const savePacket = {
                report: savedAnalysisReport,
                names: analyzedNames || "ì €ì¥ëœ ë¶„ì„ ê²°ê³¼" // ì´ë¦„ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
            };

            const now = new Date();
            const fileName = `ìœ ì‚¬ë„ ì¬ê·¸ë£¹ ê²°ê³¼_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.json`;

            const jsonStr = JSON.stringify(savePacket, null, 2);

            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            document.getElementById('analyzeBtn').style.display = 'none';
            document.getElementById('mainCompleteBtn').style.display = 'inline-block';
            document.getElementById('resetSimBtn').style.display = 'inline-block';

            showToast("ğŸ’¾ ì¬ê·¸ë£¹ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            showSavedReportModal();
        }

        function showSavedReportModal() {
            if (!savedAnalysisReport) return;
            document.getElementById('modalTitle').innerText = "ğŸ“‹ ìµœì¢… ì•ˆì „ë³´ê±´ ì¬ê·¸ë£¹ ë³´ê³ ì„œ";
            document.getElementById('saveReGroupBtn').style.display = 'none';
            document.getElementById('analysisModal').style.display = 'flex';

            // [ì¶”ê°€/ìˆ˜ì •] ì¸ì‡„ìš© í—¤ë“œë¼ì¸ê³¼ ì„œë¸Œë¼ë²¨ HTML ìƒì„±
            // ì¸ì‡„ ì‹œ ê°€ë…ì„±ì„ ìœ„í•´ í…Œë‘ë¦¬ì™€ ì—¬ë°±ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤.
            let headerHtml = `
                <div style="text-align:center; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #333;">
                    <h1 style="margin:0; font-size:24pt; color:#111;">ì„ íƒ í•­ëª© ë¬¸ì œì  ê·¸ë£¹í™” ê²°ê³¼</h1>
                    <p style="margin:10px 0 0 0; font-size:12pt; color:#555;">${analyzedNames}</p>
                </div>
            `;

            let tableHtml = `
                <table>
                    <thead style="background:#f1f5f9;">
                        <tr><th style="width:35%;text-align:center;">í•µì‹¬í‚¤ì›Œë“œ</th><th style="text-align:center;">ëª¨ë“  êµ¬ì„±ë‚´ìš©</th><th style="width:10%;text-align:center;">ë¹„ìœ¨</th></tr>
                    </thead>
                    <tbody>${savedAnalysisReport.map(r => `
                        <tr>
                            <td style="font-weight:bold; text-align:center;">${r.keyword}</td>
                            <td style="color:#555; line-height:1.6;">${r.content}</td>
                            <td style="font-weight:bold; color:var(--primary); text-align:center;">${r.ratio}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div class="no-print" style="margin-top:20px; text-align:center; display:flex; justify-content:center; gap:10px;">
                    <button class="btn" style="background:#64748b;" onclick="modifyReGroup()">âœï¸ ì¬ê·¸ë£¹ ìˆ˜ì •</button>
                    <button class="btn btn-p" onclick="window.print()">ğŸ–¨ï¸ ë³´ê³ ì„œ ì¸ì‡„</button>
                </div>`;

            // í—¤ë“œë¼ì¸ + í…Œì´ë¸” ê²°í•©í•˜ì—¬ ì¶œë ¥
            document.getElementById('analysisResultBody').innerHTML = headerHtml + tableHtml;
        }

        function modifyReGroup() {
            if (!savedAnalysisReport) return;
            document.getElementById('modalTitle').innerText = "ğŸ“Š ìœ ì‚¬ í•­ëª© ë¶„ì„ ê²°ê³¼ (AI)";
            document.getElementById('saveReGroupBtn').style.display = 'inline-block';
            const body = document.getElementById('analysisResultBody');
            body.innerHTML = '';

            savedAnalysisReport.forEach((report, idx) => {
                const isGroup = report.type === 'ê·¸ë£¹';
                const issues = report.content.split('<br>').map(s => s.replace('- ', ''));

                let items = issues.map((txt, midx) => {
                    const isFirst = midx === 0;
                    return `<li id="edit-${idx}-${midx}" class="draggable-item ${isFirst ? 'is-rep' : ''}" 
                                draggable="true" ondragstart="drag(event)" ondblclick="setRep(this)" 
                                data-text="${txt}" style="padding:8px;">
                                ${isFirst ? '<span class="badge" style="color:#10b981; font-weight:bold;">[ê¸°ì¤€]</span> ' : ''}
                                ${txt}
                            </li>`;
                }).join('');

                body.insertAdjacentHTML('beforeend', `
                    <div class="group-box ${isGroup ? 'common-group' : 'unique-group'}">
                        <div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">
                            <span class="group-tag ${isGroup ? 'tag-common' : 'tag-unique'}">${report.type}</span>
                            <strong class="kw">${report.keyword}</strong>
                        </div>
                        <ul ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" style="list-style:none; padding:0; min-height:40px;">
                            ${items}
                        </ul>
                    </div>`);
            });
        }

        function resetReGroup() {
            if (!confirm("ì €ì¥ëœ ì¬ê·¸ë£¹ ìë£Œë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            savedAnalysisReport = null;
            document.getElementById('analyzeBtn').style.display = 'inline-block';
            document.getElementById('mainCompleteBtn').style.display = 'none';
            document.getElementById('resetSimBtn').style.display = 'none';
            document.getElementById('analysisModal').style.display = 'none';
        }

        function allowDrop(ev) { ev.preventDefault(); ev.target.closest('ul')?.classList.add('drag-over'); }
        function leaveDrop(ev) { ev.target.closest('ul')?.classList.remove('drag-over'); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        function drop(ev) {
            ev.preventDefault();
            const draggedId = ev.dataTransfer.getData("text");
            const dragged = document.getElementById(draggedId);
            const targetUl = ev.target.closest('ul');
            if (targetUl && dragged) {
                const sourceBox = dragged.closest('.group-box');
                targetUl.appendChild(dragged);
                targetUl.classList.remove('drag-over');
                if (dragged.classList.contains('is-rep')) {
                    dragged.classList.remove('is-rep');
                    dragged.querySelector('.badge')?.remove();
                }
                updateStatus(targetUl.closest('.group-box'));
                if (sourceBox) updateStatus(sourceBox);
            }
        }

        function updateStatus(box) {
            const items = box.querySelectorAll('li');
            if (items.length === 0) { box.remove(); return; }
            const isGroup = items.length > 1;
            box.className = `group-box ${isGroup ? 'common-group' : 'unique-group'}`;
            box.querySelector('.group-tag').className = `group-tag ${isGroup ? 'tag-common' : 'tag-unique'}`;
            box.querySelector('.group-tag').innerText = isGroup ? 'ê·¸ë£¹' : 'ê°œë³„';
            if (!box.querySelector('.is-rep')) setRep(items[0]);
        }

        function setRep(el) {
            const ul = el.parentElement;
            ul.querySelectorAll('.is-rep').forEach(li => { li.classList.remove('is-rep'); li.querySelector('.badge')?.remove(); });
            el.classList.add('is-rep');
            el.insertAdjacentHTML('afterbegin', '<span class="badge" style="color:#10b981; font-weight:bold;">[ê¸°ì¤€] </span>');
            ul.closest('.group-box').querySelector('.kw').innerText = el.getAttribute('data-text');
        }

        function closeModal() { document.getElementById('analysisModal').style.display = 'none'; }

        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream; video.style.display = 'block';
                document.getElementById('photoPlaceholder').style.display = 'none';
                captureBtn.style.display = 'inline-block';
            } catch (err) { alert("ì¹´ë©”ë¼ ì˜¤ë¥˜: " + err.message); }
        }

        // [ìˆ˜ì •] íŒŒì¼ ì„ íƒ ì‹œ ë°”ë¡œ ê°¤ëŸ¬ë¦¬ì— ì¶”ê°€
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    // ì••ì¶• í›„ DB ì¶”ê°€
                    const compressed = await compressImage(evt.target.result, 0.4, 600);
                    addPhotoToDB(compressed);
                };
                reader.readAsDataURL(file);
            }
            e.target.value = ''; // ì´ˆê¸°í™”
        };

        // [ìˆ˜ì •] ì´¬ì˜ ë²„íŠ¼ í´ë¦­ ì‹œ (takePhoto ëŒ€ì²´)
        function takePhotoAndAdd() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const original = canvas.toDataURL('image/png');
            compressImage(original, 0.4, 600).then(compressed => {
                addPhotoToDB(compressed); // ê°¤ëŸ¬ë¦¬ ì¶”ê°€
                
                // ì¹´ë©”ë¼ ë„ê¸°
                if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
                video.style.display = 'none';
                document.getElementById('captureBtn').style.display = 'none';
            });
        }

        document.getElementById('jsonLoader').onchange = function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (evt) {
                try {
                    const loadedData = JSON.parse(evt.target.result);

                    // [í•µì‹¬ ìˆ˜ì •] ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ë³µêµ¬
                    // ìƒˆë¡œìš´ ë°©ì‹(ê°ì²´)ìœ¼ë¡œ ì €ì¥ëœ íŒŒì¼ì¸ì§€ í™•ì¸
                    if (loadedData.report && loadedData.names) {
                        savedAnalysisReport = loadedData.report;
                        analyzedNames = loadedData.names; // ì´ë¦„ ì •ë³´ ë³µêµ¬!
                    }
                    // í˜¹ì‹œ ì˜ˆì „ ë°©ì‹(ë°°ì—´ë§Œ ì €ì¥)ì¸ ê²½ìš°ì— ëŒ€í•œ ë°©ì–´ ì½”ë“œ
                    else if (Array.isArray(loadedData)) {
                        savedAnalysisReport = loadedData;
                        analyzedNames = "ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ë¶„ì„ ê²°ê³¼"; // ì´ë¦„ì´ ì—†ìœ¼ë¯€ë¡œ ì„ì˜ ì§€ì •
                    } else {
                        throw new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
                    }

                    document.getElementById('analyzeBtn').style.display = 'none';
                    document.getElementById('mainCompleteBtn').style.display = 'inline-block';
                    document.getElementById('resetSimBtn').style.display = 'inline-block';

                    showToast("ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    showSavedReportModal();

                } catch (err) {
                    console.error(err);
                    showToast("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
                }
            };

            reader.readAsText(file);
            this.value = '';
        };

        function showToast(message) {
            let toast = document.getElementById("toast-msg");
            if (!toast) {
                toast = document.createElement("div");
                toast.id = "toast-msg";
                document.body.appendChild(toast);
            }
            toast.innerText = message;
            toast.classList.add("show");
            setTimeout(function () {
                toast.classList.remove("show");
            }, 3000);
        }

        /* --- [ìˆ˜ì •] ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜ (ì´ˆê°•ë ¥ ì••ì¶• ë²„ì „) --- */
        // quality: 0.4 (í™”ì§ˆ 40% ìˆ˜ì¤€), maxWidth: 600 (ë„ˆë¹„ 600pxë¡œ ì¶•ì†Œ)
        function compressImage(imageSrc, quality = 0.4, maxWidth = 600) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imageSrc;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // ë„ˆë¹„ë¥¼ 600pxë¡œ ê°•ì œ ì¶•ì†Œ (ìŠ¤ë§ˆíŠ¸í°ì—ì„œ ë³´ê¸°ì— ì¶©ë¶„í•¨)
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // JPEG í¬ë§· + í™”ì§ˆ 0.4ë¡œ ê°•ë ¥ ì••ì¶•
                    const compressedData = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedData);
                };
            });
        }      
        
        // [ì‹ ê·œ] DBì—ì„œ ì‚¬ì§„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì»¬ë ‰ì…˜: site_photos)
        async function loadGalleryFromDB() {
            try {
                const { db, collection, getDocs, query, orderBy } = window.fs;
                const q = query(collection(db, "site_photos"), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);

                const adminGallery = document.getElementById('adminGallery');
                const userGallery = document.getElementById('userGallery');
                
                let adminHtml = '';
                let userHtml = '';

                if (snapshot.empty) {
                    adminGallery.innerHTML = '<span style="padding:20px; color:#888;">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                    userGallery.innerHTML = '<p style="text-align:center; width:100%; color:#888;">ì ê²€í•  ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // ê´€ë¦¬ììš© ì¸ë„¤ì¼ (ì‚­ì œ ë²„íŠ¼ í¬í•¨)
                    adminHtml += `
                        <div style="position:relative; min-width:120px; height:100px; border:1px solid #ddd; border-radius:4px; overflow:hidden;">
                            <img src="${data.image}" style="width:100%; height:100%; object-fit:cover;">
                            <button onclick="deletePhotoFromDB('${doc.id}')" style="position:absolute; top:0; right:0; background:red; color:white; border:none; cursor:pointer;">X</button>
                        </div>`;
                    
                    // ì‚¬ìš©ììš© ì¸ë„¤ì¼ (í´ë¦­ ì‹œ ì„ íƒ)
                    userHtml += `
                        <div onclick="selectPhoto('${data.image}')" style="cursor:pointer; border:2px solid #eee; border-radius:8px; overflow:hidden; transition:0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='#eee'">
                            <img src="${data.image}" style="width:100%; height:120px; object-fit:cover; display:block;">
                        </div>`;
                });

                adminGallery.innerHTML = adminHtml;
                userGallery.innerHTML = userHtml;

            } catch (e) {
                console.error("ê°¤ëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨:", e);
            }
        }

        // [ì‹ ê·œ] ì‚¬ì§„ DBì— ì¶”ê°€í•˜ê¸°
        async function addPhotoToDB(base64Image) {
            try {
                const { db, collection, addDoc } = window.fs;
                await addDoc(collection(db, "site_photos"), {
                    image: base64Image,
                    timestamp: Date.now()
                });
                showToast("ğŸ“¸ ì‚¬ì§„ì´ ê°¤ëŸ¬ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadGalleryFromDB(); // ëª©ë¡ ê°±ì‹ 
            } catch (e) {
                alert("ì‚¬ì§„ ì €ì¥ ì‹¤íŒ¨: " + e.message);
            }
        }

        // [ì‹ ê·œ] ì‚¬ì§„ ì‚­ì œí•˜ê¸°
        async function deletePhotoFromDB(docId) {
            if(!confirm("ì •ë§ ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const { db, doc, deleteDoc } = window.fs;
                await deleteDoc(doc(db, "site_photos", docId));
                loadGalleryFromDB();
                showToast("ğŸ—‘ï¸ ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
            }
        }

        function selectPhoto(src) {
            currentUserPhoto = src; 
            
            document.getElementById('userGalleryView').style.display = 'none';
            document.getElementById('userWorkView').style.display = 'block';
            
            renderUserPhoto(src);
            
            pinIssues = []; 
            renderUserTags();

            // [ì¶”ê°€] ì´ ì‚¬ì§„ì— ëŒ€í•œ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸°
            loadPeerReviews(src); 
        }

        // [ìˆ˜ì •] ë‹¤ì‹œ ê°¤ëŸ¬ë¦¬ë¡œ ëŒì•„ê°€ê¸° (í™”ë©´ ì´ˆê¸°í™” ê¸°ëŠ¥ ì¶”ê°€)
        function showUserGallery() {
            // 1. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ì´ë¦„, ì†Œì† ë¹„ìš°ê¸°)
            document.getElementById('userName').value = '';
            document.getElementById('userOrg').value = '';
            
            // 2. ë¬¸ì œì  ë°ì´í„° ë° íƒœê·¸ ì´ˆê¸°í™”
            pinIssues = [];
            renderUserTags(); // íƒœê·¸ í™”ë©´ ì§€ìš°ê¸°
            
            // 3. ë™ë£Œ ë¶„ì„ ë§í¬ ì˜ì—­ ìˆ¨ê¸°ê¸° ë° ì´ˆê¸°í™”
            const peerContainer = document.getElementById('peerLinksContainer');
            if (peerContainer) {
                peerContainer.style.display = 'none';
                document.getElementById('peerLinks').innerHTML = '';
            }

            // 4. í™”ë©´ ì „í™˜
            document.getElementById('userWorkView').style.display = 'none';
            document.getElementById('userGalleryView').style.display = 'block';
            
            // 5. í˜„ì¬ ì‘ì—… ì¤‘ì¸ ì‚¬ì§„ ë³€ìˆ˜ í•´ì œ
            currentUserPhoto = null;
        }

        /* [ìµœì¢…] ë™ë£Œ ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œì»¬ í•„í„°ë§ + ìµëª…í™” + ë‚´ ìë£Œ ì œì™¸) */
        function loadPeerReviews(imageSrc) {
            const container = document.getElementById('peerLinksContainer');
            const list = document.getElementById('peerLinks');
            
            // í˜„ì¬ ì…ë ¥ëœ ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë¹„êµìš©)
            const myName = document.getElementById('userName').value.trim();
            const myOrg = document.getElementById('userOrg').value.trim();
            
            // ì´ˆê¸°í™”
            list.innerHTML = '';
            container.style.display = 'block';

            try {
                // 1. ì „ì²´ ë°ì´í„°(entryList)ì—ì„œ 'ì‚¬ì§„ì´ ê°™ì€' í•­ëª©ë§Œ ì¼ë‹¨ ë‹¤ ê°€ì ¸ì˜´
                // (DB ì¿¼ë¦¬ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ë¡œì»¬ ë³€ìˆ˜ì—ì„œ ê²€ìƒ‰)
                const samePhotoItems = entryList.filter(item => item.photo === imageSrc);

                // 2. ê·¸ì¤‘ì—ì„œ 'ë‚˜(ì´ë¦„ê³¼ ì†Œì†ì´ ê°™ìŒ)'ëŠ” ì œì™¸í•¨
                const otherPeers = samePhotoItems.filter(item => 
                    !(item.name === myName && item.org === myOrg)
                );

                let count = 1; // ë¶„ì„ì ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)

                // 3. ë‚¨ì€ 'ë‹¤ë¥¸ ì‚¬ëŒë“¤'ë§Œ ë²„íŠ¼ìœ¼ë¡œ ë§Œë“¦
                otherPeers.forEach(data => {
                    const btn = document.createElement('span');
                    btn.className = 'peer-badge';
                    
                    // ì‹¤ëª… ëŒ€ì‹  'ë¶„ì„ì ë²ˆí˜¸' ì‚¬ìš©
                    const anonymousName = `ë¶„ì„ì ${count}`;
                    
                    btn.innerText = `ğŸ‘¤ ${anonymousName}`;
                    
                    // í´ë¦­ ì‹œ ëª¨ë‹¬ ë„ìš°ê¸° (ê°€ëª… ì „ë‹¬)
                    btn.onclick = () => showPeerModal(data, anonymousName); 
                    
                    list.appendChild(btn);
                    count++;
                });

                // 4. ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ì²˜ë¦¬
                const titleDiv = container.querySelector('div'); // ì œëª© ì˜ì—­

                if (count === 1) { 
                    // countê°€ 1 ê·¸ëŒ€ë¡œë¼ë©´ íƒ€ì¸ì˜ ìë£Œê°€ ì—†ë‹¤ëŠ” ëœ»
                    list.innerHTML = '<span style="font-size:12px; color:#999;">ì°¸ê³ í•  ë§Œí•œ ë‹¤ë¥¸ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                    if(titleDiv) titleDiv.innerHTML = `ğŸ’¡ ë™ë£Œë“¤ì˜ ë¶„ì„ ê²°ê³¼ (í´ë¦­í•˜ì—¬ ì°¸ê³ ):`;
                } else {
                    // íƒ€ì¸ ìë£Œê°€ ìˆìœ¼ë©´ ê±´ìˆ˜ í‘œì‹œ
                    if(titleDiv) titleDiv.innerHTML = `ğŸ’¡ ë™ë£Œë“¤ì˜ ë¶„ì„ ê²°ê³¼ <strong>${count - 1}ê±´</strong> ë°œê²¬ (í´ë¦­í•˜ì—¬ ì°¸ê³ ):`;
                }

            } catch (e) {
                console.error(e);
                list.innerHTML = '<span style="color:red;">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜</span>';
            }
        }

        /* [ìˆ˜ì •] ëª¨ë‹¬ ë„ìš°ê¸° (ê°€ëª… íŒŒë¼ë¯¸í„° ì¶”ê°€) */
        function showPeerModal(data, alias) {
            const modal = document.getElementById('peerModal');
            const title = document.getElementById('peerModalTitle');
            const content = document.getElementById('peerModalContent');

            // [í•µì‹¬ ìˆ˜ì •] ì „ë‹¬ë°›ì€ ê°€ëª…(alias)ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
            title.innerText = `${alias}ì˜ ì§€ì  ì‚¬í•­`;
            
            let html = `<ul style="padding-left:20px; margin:0;">`;
            data.issues.forEach(issue => {
                html += `<li style="margin-bottom:5px;">${issue}</li>`;
            });
            html += `</ul>`;
            
            // (ì„ íƒì‚¬í•­) í•˜ë‹¨ì— ì‘ê²Œ ì†Œì† ì •ë„ë§Œ ë³´ì—¬ì¤„ì§€, ì•„ì˜ˆ ìˆ¨ê¸¸ì§€ ê²°ì • ê°€ëŠ¥
            // html += `<div style="margin-top:10px; font-size:11px; color:#888; text-align:right;">- ${data.org} ì†Œì† -</div>`;

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function closePeerModal() {
            document.getElementById('peerModal').style.display = 'none';
        }

        /* [ì‹ ê·œ] ëª¨ë‹¬ ë“œë˜ê·¸ ì´ë™ ë¡œì§ (ë§ˆìš°ìŠ¤ & í„°ì¹˜ ì§€ì›) */
        const dragModal = document.getElementById("peerModal");
        const dragHeader = document.getElementById("peerModalHeader");
        let isDragging = false, startX, startY, initialLeft, initialTop;

        dragHeader.onmousedown = dragStart;
        dragHeader.ontouchstart = dragStart;

        function dragStart(e) {
            isDragging = true;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            startX = clientX;
            startY = clientY;
            initialLeft = dragModal.offsetLeft;
            initialTop = dragModal.offsetTop;
            document.onmouseup = dragEnd;
            document.onmousemove = dragMove;
            document.ontouchend = dragEnd;
            document.ontouchmove = dragMove;
        }

        function dragMove(e) {
            if (!isDragging) return;
            e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const dx = clientX - startX;
            const dy = clientY - startY;
            dragModal.style.left = `${initialLeft + dx}px`;
            dragModal.style.top = `${initialTop + dy}px`;
        }

        function dragEnd() {
            isDragging = false;
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
        }
    </script>
</body>


</html>

